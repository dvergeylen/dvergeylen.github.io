<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.1.1">Jekyll</generator><link href="/feed.xml" rel="self" type="application/atom+xml" /><link href="/" rel="alternate" type="text/html" /><updated>2021-11-15T09:41:16+00:00</updated><id>/feed.xml</id><title type="html">Daniel Vergeylen</title><subtitle>Embedded HW/SW, Linux stuff and programming. Always learning!</subtitle><entry><title type="html">[C++] List of different types via `unique_ptr`s</title><link href="/c++-heterogeneous-list" rel="alternate" type="text/html" title="[C++] List of different types via `unique_ptr`s" /><published>2021-04-13T10:30:00+00:00</published><updated>2021-04-13T10:30:00+00:00</updated><id>/heterogeneous-list-of-elements-C++</id><content type="html" xml:base="/c++-heterogeneous-list">&lt;h4 id=&quot;introduction&quot;&gt;Introduction&lt;/h4&gt;
&lt;p&gt;One of the most powerful techniques in C++ is the ability to define templated classes and structs. These abstract methods can contain “things” that the developer will specify when instantiating them (“here is a list of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;int&lt;/code&gt;, here is a list of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;my_struct&lt;/code&gt;, and so on), declinating the implementation with existing type in the code but always using the same definition as starting point every time.&lt;/p&gt;

&lt;p&gt;The main setback of this (already powerful) concept is that a type, once given, won’t change because it is determined at compile time. There is no way to create a list of “things” and then start adding &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;int&lt;/code&gt;s, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;my_struct&lt;/code&gt;s and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;my_other_struct&lt;/code&gt;s elements at the same time. This would definitely make the compiler very angry.&lt;/p&gt;

&lt;p&gt;There is nevertheless a very subtle trick when combining templating, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;unique_ptr&lt;/code&gt; and class inheritance.&lt;/p&gt;

&lt;h5 id=&quot;implementation&quot;&gt;Implementation&lt;/h5&gt;
&lt;p&gt;The trick is to define a Base Class, and then define Derived Classes as needed. When creating a list, one can create a list of Base Class unique_ptr, pointing at Derived Class objects, which is legal (because they are “implicitly convertible”, see &lt;a href=&quot;https://en.cppreference.com/w/cpp/memory/unique_ptr&quot;&gt;here&lt;/a&gt;).&lt;/p&gt;

&lt;div class=&quot;language-cpp highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;#include &amp;lt;iostream&amp;gt;
#include &amp;lt;list&amp;gt;
#include &amp;lt;memory&amp;gt;
&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Vehicule&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;nl&quot;&gt;public:&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;Vehicule&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// Defining it as virtual forces derived class&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// destructors to be called when unique_ptr goes&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// out of scope.&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// See: https://en.cppreference.com/w/cpp/langulength/virtual&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;virtual&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Vehicule&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;virtual&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;honk&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cout&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;This should never happen&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Car&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Vehicule&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;color&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;boot_capacity&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;nl&quot;&gt;public:&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;Car&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;color&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;boot_capacity&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Vehicule&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
                                                 &lt;span class=&quot;n&quot;&gt;color&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;color&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
                                                 &lt;span class=&quot;n&quot;&gt;boot_capacity&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;boot_capacity&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Car&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cout&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Car Destructor Called&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;honk&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;override&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cout&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Beep Beep!&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Truck&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Vehicule&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;color&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;driver&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;nl&quot;&gt;public:&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;Truck&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;color&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;driver&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Vehicule&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
                                                             &lt;span class=&quot;n&quot;&gt;color&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;color&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
                                                             &lt;span class=&quot;n&quot;&gt;driver&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;driver&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;
  &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Truck&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cout&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Truck Destructor Called&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;honk&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;override&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cout&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;Tuut Tuut!&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;endl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;

&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;unique_ptr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Vehicule&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;my_list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;cm&quot;&gt;/* Here is the trick: make_unique of the Derived Class
   * but define the unique_ptr with the Base Class */&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;unique_ptr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Vehicule&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;car_ptr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;make_unique&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Car&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;yellow&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;300&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;unique_ptr&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Vehicule&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;truck_ptr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;make_unique&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Truck&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;black&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;John&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

  &lt;span class=&quot;cm&quot;&gt;/* Pushing them on the Base Class list is perfectly legal */&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;my_list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;push_back&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;move&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;car_ptr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;my_list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;push_back&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;move&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;truck_ptr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;auto&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;my_list&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;honk&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Compiling:&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;g++ &lt;span class=&quot;nt&quot;&gt;-g&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-std&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;c++17 &lt;span class=&quot;nt&quot;&gt;-Wall&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Werror&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Wextra&lt;/span&gt; main.cpp
./a.out
&lt;span class=&quot;c&quot;&gt;# Outputs:&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# Beep Beep!&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# Tuut Tuut!&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# Car Destructor Called&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# Truck Destructor Called&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name></name></author><category term="snippets" /><summary type="html">Introduction One of the most powerful techniques in C++ is the ability to define templated classes and structs. These abstract methods can contain “things” that the developer will specify when instantiating them (“here is a list of int, here is a list of my_struct, and so on), declinating the implementation with existing type in the code but always using the same definition as starting point every time.</summary></entry><entry><title type="html">[2/5] Self hosted Nextcloud 20+</title><link href="/self-hosted-nextcloud-on-sbc-complete-guide-part2" rel="alternate" type="text/html" title="[2/5] Self hosted Nextcloud 20+" /><published>2021-03-23T10:30:00+00:00</published><updated>2021-03-23T10:30:00+00:00</updated><id>/complete-guide-to-self-hosted-nextcloud-part2</id><content type="html" xml:base="/self-hosted-nextcloud-on-sbc-complete-guide-part2">&lt;h2 id=&quot;see-also&quot;&gt;See also&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part1&quot;&gt;PART 1&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;PART 2 ← You are here 🙂&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part3&quot;&gt;PART 3&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part4&quot;&gt;PART 4&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part5&quot;&gt;PART 5&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;read-only-root&quot;&gt;Read only root&lt;/h2&gt;
&lt;p&gt;A read only root partition is very useful when running a web server from a single board computer, as it will dramatically decrease the number of writes on the SDCard (which is the usual point-of-failure). Inexperienced users will usually encounter no problem installing and exposing a web server to the Internet but will most probably see serious damages on their SD Card a few months later. This is due to incoming Internet traffic (legit one but also bots, …) that will lead to spurious writes on the SDCard. Setting the root file system as read only non only prevents such writes but also avoids the necessity to track which processes are trying to write whatever information.&lt;/p&gt;

&lt;p&gt;“Read only” is a bit of an overstatement though, as we’ll actually set an &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;overlayfs&lt;/code&gt;, two partitions used for the same purpose. The former to read new chunks of data (the original &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/&lt;/code&gt;) and the latter as a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;tmpfs&lt;/code&gt; filesystem where the OS will write them back.&lt;/p&gt;

&lt;p&gt;(→ It actually goes the other way round: the OS tries to find data from the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;tmpfs&lt;/code&gt; partition and if nothing is found, falls back to read the information from the overlayed (read-only) partition.&lt;/p&gt;

&lt;p&gt;When rebooted, the OS will loose the data written to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;tmpfs&lt;/code&gt; partition and start from a known state (untouched &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/&lt;/code&gt;).&lt;/p&gt;

&lt;h4 id=&quot;ensuring-kernel-has-overlayfs-as-a-module&quot;&gt;Ensuring kernel has &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;overlayfs&lt;/code&gt; as a module&lt;/h4&gt;
&lt;p&gt;We’ll use the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;overlayroot&lt;/code&gt; script from &lt;a href=&quot;https://packages.ubuntu.com/groovy/overlayroot&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;overlayroot&lt;/code&gt;&lt;/a&gt; package from Ubuntu. At this time of writing, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;overlayroot&lt;/code&gt; &lt;a href=&quot;https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=860915&quot;&gt;is not available in the Debian packages&lt;/a&gt;) although its source package &lt;a href=&quot;https://tracker.debian.org/pkg/cloud-initramfs-tools&quot;&gt;cloud-initramfs-tools&lt;/a&gt; is still maintained.&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;overlayroot&lt;/code&gt; needs &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;overlayfs&lt;/code&gt; to be compiled as a module, &lt;em&gt;not&lt;/em&gt; in hard in the kernel. To ensure this is the case, check &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/proc/filesystems&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# Load the overlayfs module:&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;modprobe overlay

&lt;span class=&quot;nb&quot;&gt;grep &lt;/span&gt;overlay /proc/filesystems
&lt;span class=&quot;c&quot;&gt;# Outputs:&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# nodev	overlay&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;If you see the same output as above, you can skip the next section.&lt;/li&gt;
  &lt;li&gt;If you don’t see the correct output or loading the module fails, you’ll have to recompile the kernel with the appropriate options, see Part 1.&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&quot;installing-and-configuring-overylayroot&quot;&gt;Installing and configuring &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;overylayroot&lt;/code&gt;&lt;/h4&gt;
&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;overlayroot&lt;/code&gt; is a script that automatically mounts and overlayFS &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/&lt;/code&gt;, mounting a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;tmpfs&lt;/code&gt; as updir.&lt;/p&gt;

&lt;p&gt;As said above, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;overlayroot&lt;/code&gt; is not directly available in Debian packages, so we download it from Ubuntu package repositories.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# ON THE TARGET MACHINE&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;apt &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;cryptsetup cryptsetup-bin
wget http://fr.archive.ubuntu.com/ubuntu/pool/main/c/cloud-initramfs-tools/overlayroot_0.47ubuntu1_all.deb
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;dpkg &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; overlayroot_0.47ubuntu1_all.deb

&lt;span class=&quot;c&quot;&gt;# Don't edit /etc/overlay.conf as it's part of the package&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# Edit/Create /etc/overlayroot.local.conf instead and add the following:&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;overlayroot&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;tmpfs:swap=1,recurse=0&quot;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# tmpfs → updir is a tmpfs&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# swap:1 → allows mounting swaps listed in /etc/fstab (otherwise they are left unmounted)&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# recurse=0 → do not mount the child partitions in overlay mount.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# For instance, if /home is a distinct partition it won't be mounted in overlay mode (same for /boot, /media, etc)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This will mount original &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/&lt;/code&gt; in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/media/root-ro&lt;/code&gt; and a (tmpfs) updir in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/media/root-rw&lt;/code&gt;, an overlay in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/media/root-rw/overlay&lt;/code&gt; and a workdir un &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/media/root-rw/overlay-workdir&lt;/code&gt;.&lt;/p&gt;

&lt;h5 id=&quot;rebooting&quot;&gt;Rebooting&lt;/h5&gt;
&lt;p&gt;After reboot, inspecting &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;mount&lt;/code&gt;’s output gives:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mount
&lt;span class=&quot;c&quot;&gt;# [...]&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# /dev/mmcblk0p2 on /media/root-ro type ext4 (rw,relatime,data=ordered)&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# tmpfs-root on /media/root-rw type tmpfs (rw,relatime)&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# overlayroot on / type overlay (rw,relatime,lowerdir=/media/root-ro,upperdir=/media/root-rw/overlay,workdir=/media/root-rw/overlay-workdir/_)&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# [...]&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# /dev/mmcblk0p1 on /boot type vfat (rw,relatime,fmask=0022,dmask=0022,codepage=437,iocharset=iso8859-1,shortname=mixed,errors=remount-ro)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Yeah 😎!&lt;/p&gt;

&lt;h5 id=&quot;troubleshooting&quot;&gt;Troubleshooting&lt;/h5&gt;
&lt;p&gt;If you don’t see the output above, you might be missing an initrd script. To create one, run&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;export &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;PATH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/usr/sbin:&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$PATH&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;update-initramfs &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-k&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;uname&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-r&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This will create an initrd file in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/boot&lt;/code&gt;. To tell u-boot to use it on startup, edit &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/boot/extlinux/extlinux.conf&lt;/code&gt; file and add a ‘initrd’ config line:&lt;/p&gt;

&lt;div class=&quot;language-conf highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;  &lt;span class=&quot;n&quot;&gt;label&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;kernel&lt;/span&gt;-&lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;.&lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;.&lt;span class=&quot;m&quot;&gt;144&lt;/span&gt;+
  &lt;span class=&quot;n&quot;&gt;kernel&lt;/span&gt; /&lt;span class=&quot;n&quot;&gt;zImage&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;fdt&lt;/span&gt; /&lt;span class=&quot;n&quot;&gt;rk3288&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;tinker&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;dtb&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;initrd&lt;/span&gt; /&lt;span class=&quot;n&quot;&gt;initrd&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;img&lt;/span&gt;-&lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;.&lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;.&lt;span class=&quot;m&quot;&gt;144&lt;/span&gt;+
  &lt;span class=&quot;n&quot;&gt;append&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;earlyprintk&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;splash&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;console&lt;/span&gt;=&lt;span class=&quot;n&quot;&gt;ttyS3&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;console&lt;/span&gt;=&lt;span class=&quot;n&quot;&gt;tty1&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rw&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;init&lt;/span&gt;=/&lt;span class=&quot;n&quot;&gt;sbin&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;init&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Replace ‘initrd’ suffix by your kernel version.&lt;/p&gt;

&lt;h2 id=&quot;strengthening-the-read-only&quot;&gt;Strengthening the read only&lt;/h2&gt;
&lt;p&gt;Although overlayFS doesn’t make more than necessary use of SDCard, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;overlayroot&lt;/code&gt; mounts it in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/media/root-ro&lt;/code&gt; with default options. This includes &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;rw&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;relatime&lt;/code&gt;, which doesn’t prevent writes on the partition.&lt;/p&gt;

&lt;p&gt;To enforce the read-only status of the parititon, we can write a script to remount &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/media/root-ro&lt;/code&gt; in read only mode if appears in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;mount&lt;/code&gt; output.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# ⚠️ be sure to deactivate overlayroot before executing this command,&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# otherwise your modifications will be lost after reboot!&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# (comment /etc/overlayroot.local.conf and reboot)&lt;/span&gt;

&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;vim /media/root-ro/root/remount_root_ro.sh

&lt;span class=&quot;c&quot;&gt;# Add the following content:&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#!/usr/bin/env sh&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;mount | &lt;span class=&quot;nb&quot;&gt;grep&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;/media/root-ro&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-gt&lt;/span&gt; 0 &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then
  &lt;/span&gt;mount &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; remount,defaults,noatime,ro &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; ext4 /dev/mmcblk0p2 /media/root-ro
&lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# End of file content&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# Restrict the permissions to 'root' user:&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo chmod &lt;/span&gt;744 /media/root-ro/root/remount_root_ro.sh &lt;span class=&quot;c&quot;&gt;# rwx r-- r--&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# Install cron:&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;apt &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;cron
&lt;span class=&quot;nb&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; root crontab &lt;span class=&quot;nt&quot;&gt;-e&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# add the following line:&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# @reboot /media/root-ro/root/remount_root_ro.sh&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After reboot, we now have:&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;mount
&lt;span class=&quot;c&quot;&gt;# [...]&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# /dev/mmcblk0p2 on /media/root-ro type ext4 (ro,noatime,data=ordered)&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# [...]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Which is indeed read-only! 😎&lt;/p&gt;

&lt;h2 id=&quot;hardware-crypto-acceleration-support-config_crypto_dev_rockchip&quot;&gt;Hardware Crypto acceleration support (CONFIG_CRYPTO_DEV_ROCKCHIP)&lt;/h2&gt;
&lt;p&gt;To enable support of the hardware crypto acceleration, one will set &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;CONFIG_CRYPTO_DEV_ROCKCHIP&lt;/code&gt; to ‘m’. The option can be found at at ‘ Cryptographic API’ → ‘Hardware crypto devices’ → ‘Rockchip’s Cryptographic Engine driver’ in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;make ARCH=arm menuconfig&lt;/code&gt; (forgetting &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ARCH=arm&lt;/code&gt; won’t display the option).&lt;/p&gt;

&lt;p&gt;Ensure module loads at every boot time by editing &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/modules-load.d/modules.conf&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# /etc/modules: kernel modules to load at boot time.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# This file contains the names of kernel modules that should be loaded&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# at boot time, one per line. Lines beginning with &quot;#&quot; are ignored.&lt;/span&gt;
rk_crypto
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;double-check&quot;&gt;Double check&lt;/h5&gt;
&lt;p&gt;Boot your device and check via &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;lsmod | grep crypto&lt;/code&gt; (should output &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;rk_crypto&lt;/code&gt;). 🎉&lt;/p&gt;

&lt;h2 id=&quot;next&quot;&gt;Next&lt;/h2&gt;

&lt;p&gt;See &lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part3&quot;&gt;PART 3&lt;/a&gt;&lt;/p&gt;</content><author><name></name></author><category term="nextcloud" /><summary type="html">See also PART 1 PART 2 ← You are here 🙂 PART 3 PART 4 PART 5</summary></entry><entry><title type="html">[3/5] Self hosted Nextcloud 20+</title><link href="/self-hosted-nextcloud-on-sbc-complete-guide-part3" rel="alternate" type="text/html" title="[3/5] Self hosted Nextcloud 20+" /><published>2021-03-23T10:30:00+00:00</published><updated>2021-03-23T10:30:00+00:00</updated><id>/complete-guide-to-self-hosted-nextcloud-part3</id><content type="html" xml:base="/self-hosted-nextcloud-on-sbc-complete-guide-part3">&lt;h2 id=&quot;see-also&quot;&gt;See also&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part1&quot;&gt;PART 1&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part2&quot;&gt;PART 2&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;PART 3 ← You are here 🙂&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part4&quot;&gt;PART 4&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part5&quot;&gt;PART 5&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p class=&quot;info&quot;&gt;
  💾 This part deals with the installation of Nextcloud itself, now that we have a minimal install + a strong filesystem to support it. Expect it to last years with minimal maintenance (mainly major releases to major releases updates) as it should be. Set it and forget it! 🏋️
&lt;/p&gt;

&lt;p class=&quot;warning&quot;&gt;
⚠️ Temporarily deactivate &lt;code&gt;overlayroot&lt;/code&gt; first as we will need to write access to `/`: &lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part5#deactivate-read-only-root&quot;&gt;PART 5: deactivate read only root&lt;/a&gt;, otherwise your configuration will be lost at next reboot!
&lt;/p&gt;

&lt;h2 id=&quot;installing-mariadb&quot;&gt;Installing MariaDB&lt;/h2&gt;
&lt;p&gt;We need to install MariaDB before Nextcloud as the latter will ask to which DB we want it to connect to.&lt;/p&gt;

&lt;p&gt;I assume we will connect and external hard drive and install MariaDB + Nextcloud on it (at least their data files). Assuming drive is mounted in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/media/data&lt;/code&gt; hereafter.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo mkdir&lt;/span&gt; /media/data
&lt;span class=&quot;nb&quot;&gt;sudo chown&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-R&lt;/span&gt; sheeva:sheeva /media/data
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;mount &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; ext4 /dev/disk/by-uuid/XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX /media/data/

&lt;span class=&quot;c&quot;&gt;# For a permanent mount at boot time, edit /etc/fstab :&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# UUID=XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX	/media/data/	ext4	defaults	0	2&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We can now install MariaDB, specifying that the data files will be in a specific folder in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/media/data&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# Installing packages&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;apt &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;mariadb-server mariadb-client

&lt;span class=&quot;c&quot;&gt;# Stopping the service&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;service mysql stop

&lt;span class=&quot;c&quot;&gt;# Moving datadir directory to external hard drive&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;mkdir&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; /media/data/mysql/datadir
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;rsync &lt;span class=&quot;nt&quot;&gt;-av&lt;/span&gt; /var/lib/mysql/ /media/data/mysql/datadir &lt;span class=&quot;c&quot;&gt;# rsync to keep files creation dates&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo chgrp&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-R&lt;/span&gt; mysql /media/data/mysql

&lt;span class=&quot;c&quot;&gt;# Update datadir in config&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# datadir = /media/data/mysql/datadir&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;vim /etc/mysql/mariadb.conf.d/50-server.cnf &lt;span class=&quot;c&quot;&gt;# → update datadir line&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# Add permissions for MariaDB to start sockets&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# See: https://support.plesk.com/hc/en-us/articles/213918525-MySQL-does-not-start-Bind-on-unix-socket-Permission-denied&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# at 2 places, group is 'root' instead of 'mysql'&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo chgrp &lt;/span&gt;mysql /var/run/mysqld/
&lt;span class=&quot;nb&quot;&gt;sudo chgrp &lt;/span&gt;mysql /media/data/mysql/datadir/mysql/

&lt;span class=&quot;c&quot;&gt;# Restart mariadb service&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;service mariadb start

&lt;span class=&quot;c&quot;&gt;# Secure installation&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;mysql_secure_installation &lt;span class=&quot;c&quot;&gt;# will ask questions&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# Move the original config file so that&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# we are sure we are not using it anymore&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo mv&lt;/span&gt; /var/lib/mysql /var/lib/mysql-old
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Make sure the service is started at boot:&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl is-enabled mysql.service &lt;span class=&quot;c&quot;&gt;# outputs enabled/disabled&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl disable mysql.service
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;mariadb.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Accessing MySQL content via command line interface is done via the following command:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;mysql &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; root &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# password will be asked dynamically&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It might be possible that your Debian installation configures unix_socket authentication by default, meaning &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt; user can log in without password (same for &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$USER&lt;/code&gt; via &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sudo&lt;/code&gt;). This means it’s impossible to connect to MariaDB’s cli via &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;mysql -u root -p&lt;/code&gt; command, the password option is ignored. One can see it as a warning is logged in MariaDB’s logs:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo tail&lt;/span&gt; /var/log/mysql/error.log
&lt;span class=&quot;c&quot;&gt;# [...]&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# 2018-10-27 18:23:31 3063459840 [Warning] 'user' entry 'root@localhost' has both a password and an authentication plugin specified. The password will be ignored.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# [...]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Source: &lt;a href=&quot;https://stackoverflow.com/questions/43439111/mariadb-warning-rootlocalhost-has-both-the-password-will-be-ignored#43439309&quot;&gt;MariaDB Ubuntu root login&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Source: &lt;a href=&quot;https://serverfault.com/q/872478&quot;&gt;Relocate Datadir folder&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;installing-nextcloud&quot;&gt;Installing Nextcloud&lt;/h2&gt;

&lt;h4 id=&quot;creating-nextcloud-user&quot;&gt;Creating Nextcloud user&lt;/h4&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;mysql &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; root
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; CREATE USER &lt;span class=&quot;s1&quot;&gt;'nextcloud_user'&lt;/span&gt;@&lt;span class=&quot;s1&quot;&gt;'localhost'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# Query OK, 0 rows affected (0.00 sec)&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; GRANT ALL PRIVILEGES ON nextcloud.&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; To &lt;span class=&quot;s1&quot;&gt;'nextcloud_user'&lt;/span&gt;@&lt;span class=&quot;s1&quot;&gt;'localhost'&lt;/span&gt; IDENTIFIED BY &lt;span class=&quot;s1&quot;&gt;'$YOURPASSWORD'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# Query OK, 0 rows affected (0.00 sec)&lt;/span&gt;
MariaDB &lt;span class=&quot;o&quot;&gt;[(&lt;/span&gt;none&lt;span class=&quot;o&quot;&gt;)]&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;exit&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;installing-nextcloud-required-packages&quot;&gt;Installing Nextcloud required packages&lt;/h4&gt;
&lt;p&gt;The procedure is quiet straightforward as written in &lt;a href=&quot;https://docs.nextcloud.com/server/17/admin_manual/installation/source_installation.html#prerequisites-label&quot;&gt;the doc&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Needed packages:&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# Essentials:&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;apt &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;apache2 php7.3/stable php7.3-gd/stable php7.3-xml/stable php7.3-mbstring/stable php7.3-zip/stable php7.3-curl/stable php7.3-json/stable libxml2

&lt;span class=&quot;c&quot;&gt;# Specifics:&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;apt &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;php7.3-mysql &lt;span class=&quot;c&quot;&gt;# MySQL / MariaDB Connector&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;apt &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;php-apcu     &lt;span class=&quot;c&quot;&gt;# Local cache → https://docs.nextcloud.com/server/latest/admin_manual/configuration_server/caching_configuration.html&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# Higly recommended&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# PHP module bz2 (recommended, required for extraction of apps)&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# PHP module intl (increases language translation performance and fixes sorting of non-ASCII characters)&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# php-imagick otherwise NextCloud security check overview complains&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;apt &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;php7.3-bz2/stable php7.3-intl/stable php-imagick/stable php-gmp/stable php-bcmath/stable ssl-cert
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;⚠ Don’t forget to configure cache in nextcloud’s config (&lt;a href=&quot;https://docs.nextcloud.com/server/12/admin_manual/configuration_server/caching_configuration.html#id1&quot;&gt;APCU cache Doc&lt;/a&gt;), see below.&lt;/p&gt;

&lt;p&gt;⚠ No need to install &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;mod_webdav&lt;/code&gt; module as Nextcloud now includes a webdav server itself (see last paragraph of &lt;a href=&quot;https://docs.nextcloud.com/server/latest/admin_manual/installation/source_installation.html#prerequisites-for-manual-installation&quot;&gt;this section&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;Source: &lt;a href=&quot;https://docs.nextcloud.com/server/latest/admin_manual/configuration_server/occ_command.html#command-line-installation-label&quot;&gt;Nextcloud command line installation&lt;/a&gt;&lt;/p&gt;

&lt;h4 id=&quot;creating-a-nextcloud-data-folder&quot;&gt;Creating a Nextcloud data folder&lt;/h4&gt;
&lt;p&gt;Folder must be writable to user &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;www-data&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;mkdir&lt;/span&gt; /media/data/nextcloud /media/data/nextcloud_tmp_dir
&lt;span class=&quot;nb&quot;&gt;sudo chmod &lt;/span&gt;0770 /media/data/nextcloud /media/data/nextcloud_tmp_dir
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;apt &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;acl
setfacl &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; u:www-data:rwx /media/data/nextcloud
setfacl &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; u:www-data:rwx /media/data/nextcloud_tmp_dir
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;downloading-latest-nextcloud-archive&quot;&gt;Downloading latest Nextcloud archive&lt;/h4&gt;
&lt;p&gt;There is unfortunately no official PPA for Debian, one must download a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.zip&lt;/code&gt; archive from &lt;a href=&quot;https://nextcloud.com/install/#&quot;&gt;Nextcloud homepage&lt;/a&gt;. Upgrades are done via a Nextcloud app (&lt;a href=&quot;https://docs.nextcloud.com/server/latest/admin_manual/maintenance/upgrade.html&quot;&gt;Updater App&lt;/a&gt;).&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; /tmp

&lt;span class=&quot;c&quot;&gt;# NextCloud&lt;/span&gt;
curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-O&lt;/span&gt; https://download.nextcloud.com/server/releases/nextcloud-21.0.4.zip

&lt;span class=&quot;c&quot;&gt;# SHA256&lt;/span&gt;
curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-O&lt;/span&gt; https://download.nextcloud.com/server/releases/nextcloud-21.0.4.zip.sha256

&lt;span class=&quot;c&quot;&gt;# Check download OK :&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sha256sum&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt; nextcloud-21.0.0.sha256 &amp;lt; nextcloud-21.0.0.zip
&lt;span class=&quot;c&quot;&gt;# nextcloud-21.0.0.zip: OK&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;launching-nextcloud-installer&quot;&gt;Launching Nextcloud installer&lt;/h4&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;unzip nextcloud-21.0.4.zip
&lt;span class=&quot;nb&quot;&gt;sudo mv &lt;/span&gt;nextcloud /var/www/
&lt;span class=&quot;nb&quot;&gt;sudo chown&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-R&lt;/span&gt; www-data:www-data /var/www/nextcloud
&lt;span class=&quot;nb&quot;&gt;sudo chmod &lt;/span&gt;0770 /var/www/nextcloud
&lt;span class=&quot;nb&quot;&gt;sudo chmod &lt;/span&gt;0770 /media/data/nextcloud/
&lt;span class=&quot;c&quot;&gt;# See: https://docs.nextcloud.com/server/latest/admin_manual/installation/command_line_installation.html&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# Launch Nextcloud install script via the following command :&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# Adapt $DATABASE_PWD, $ADMIN_LOGIN and $ADMIN_PWD accordingly&lt;/span&gt;
su root
&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; /var/www/nextcloud
&lt;span class=&quot;nb&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; www-data php occ maintenance:install &lt;span class=&quot;nt&quot;&gt;--database&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;mysql&quot;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--database-name&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;nextcloud&quot;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--database-user&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;nextcloud_user&quot;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--database-pass&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$DATABASE_PWD&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--admin-user&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$ADMIN_LOGIN&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--admin-pass&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$ADMIN_PWD&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--data-dir&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;/media/data/nextcloud&quot;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;exit&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# Nextcloud was successfully installed&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# If you encounter the following error:&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# &quot;Username is invalid because files already exist for this user&quot;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# Problem is documented here: https://github.com/nextcloud/server/blob/master/lib/private/User/Manager.php#L630&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# You unfortunately need to delete /media/data/nextcloud/ 's content, otherwise installer find some files and considers admin user already exist. There is probably a cleaner way to do this but I assume this is a fresh install. 😇&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Yeah 😎!&lt;/p&gt;

&lt;h2 id=&quot;installing-and-configuring-nginx&quot;&gt;Installing and Configuring Nginx&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;Keep in mind this is a starting point, you should know what you are doing. See &lt;a href=&quot;https://docs.nextcloud.com/server/latest/admin_manual/installation/nginx.html&quot;&gt;Nextcloud documentation&lt;/a&gt; for more information.&lt;/li&gt;
  &lt;li&gt;Don’t forget to replace &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$YOUR_DOMAIN_NAME&lt;/code&gt; by your domain name in the configuration given below.&lt;/li&gt;
  &lt;li&gt;See the line &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;listen 443 ssl http2;&lt;/code&gt;? You’ll be serving HTTP/2 requests!&lt;/li&gt;
  &lt;li&gt;This will give you an A+ score at SSL Labs. It needs a Let’s Encrypt SSL Certificate generation, covered in Part 4.&lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;I’ve replaced the SSL Certificates path with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/path/to/XXX&lt;/code&gt; for now.&lt;/p&gt;

    &lt;p&gt;&lt;img src=&quot;assets/images/nextcloud/SSLLabs_Aplus.png&quot; alt=&quot;SSL Labs A+ Score&quot; /&gt;
&lt;em&gt;SSL Labs Test Score: A+&lt;/em&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# Installing Nginx
sudo apt install nginx php-fpm
sudo nginx -v # gives you the installed version

# Removing default website
sudo rm /etc/nginx/sites-available/default /etc/nginx/sites-enabled/default
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Create a new config file via &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sudo vim /etc/nginx/sites-available/nextcloud.conf&lt;/code&gt; and paste the content below.&lt;/p&gt;

&lt;div class=&quot;language-conf highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;upstream&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;php&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;handler&lt;/span&gt; {
&lt;span class=&quot;c&quot;&gt;#    server 127.0.0.1:9000;
&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;server&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;unix&lt;/span&gt;:/&lt;span class=&quot;n&quot;&gt;var&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;run&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;php&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;php7&lt;/span&gt;.&lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;fpm&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;sock&lt;/span&gt;;
}

&lt;span class=&quot;n&quot;&gt;server&lt;/span&gt; {
    &lt;span class=&quot;n&quot;&gt;listen&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;80&lt;/span&gt;;
    &lt;span class=&quot;n&quot;&gt;listen&lt;/span&gt; [::]:&lt;span class=&quot;m&quot;&gt;80&lt;/span&gt;;
    &lt;span class=&quot;n&quot;&gt;server_name&lt;/span&gt; $&lt;span class=&quot;n&quot;&gt;YOUR_DOMAIN_NAME&lt;/span&gt;;
    &lt;span class=&quot;c&quot;&gt;# enforce https
&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;301&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;https&lt;/span&gt;://$&lt;span class=&quot;n&quot;&gt;server_name&lt;/span&gt;:&lt;span class=&quot;m&quot;&gt;444&lt;/span&gt;$&lt;span class=&quot;n&quot;&gt;request_uri&lt;/span&gt;;
}

&lt;span class=&quot;n&quot;&gt;server&lt;/span&gt; {
    &lt;span class=&quot;n&quot;&gt;listen&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;443&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ssl&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;http2&lt;/span&gt;;
    &lt;span class=&quot;n&quot;&gt;listen&lt;/span&gt; [::]:&lt;span class=&quot;m&quot;&gt;443&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ssl&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;http2&lt;/span&gt;;
    &lt;span class=&quot;n&quot;&gt;server_name&lt;/span&gt; $&lt;span class=&quot;n&quot;&gt;YOUR_DOMAIN_NAME&lt;/span&gt;;

    &lt;span class=&quot;c&quot;&gt;# TLS CONFIGURATION
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;# We'll update this shortly (see PART 4)
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;# ssl_certificate /path/to/fullchain.cer;
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;# ssl_certificate_key /path/to/private_key.key;
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;# ssl_dhparam /path/to/dhparam.pem;        # openssl dhparam -out /etc/nginx/dhparam.pem 4096
&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;ssl_protocols&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TLSv1&lt;/span&gt;.&lt;span class=&quot;m&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TLSv1&lt;/span&gt;.&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;;             &lt;span class=&quot;c&quot;&gt;# Requires nginx &amp;gt;= 1.13.0 else use TLSv1.2
&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;ssl_prefer_server_ciphers&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;on&lt;/span&gt;;
    &lt;span class=&quot;n&quot;&gt;ssl_ciphers&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;EECDH&lt;/span&gt;+&lt;span class=&quot;n&quot;&gt;AESGCM&lt;/span&gt;:&lt;span class=&quot;n&quot;&gt;EDH&lt;/span&gt;+&lt;span class=&quot;n&quot;&gt;AESGCM&lt;/span&gt;;
    &lt;span class=&quot;n&quot;&gt;ssl_ecdh_curve&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;secp384r1&lt;/span&gt;;                  &lt;span class=&quot;c&quot;&gt;# Requires nginx &amp;gt;= 1.1.0
&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;ssl_session_timeout&lt;/span&gt;  &lt;span class=&quot;m&quot;&gt;60&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;;
    &lt;span class=&quot;n&quot;&gt;ssl_session_cache&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;shared&lt;/span&gt;:&lt;span class=&quot;n&quot;&gt;SSL&lt;/span&gt;:&lt;span class=&quot;m&quot;&gt;60&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;m&lt;/span&gt;;
    &lt;span class=&quot;n&quot;&gt;ssl_session_tickets&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;off&lt;/span&gt;;                   &lt;span class=&quot;c&quot;&gt;# Requires nginx &amp;gt;= 1.5.9
&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;ssl_stapling&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;on&lt;/span&gt;; &lt;span class=&quot;c&quot;&gt;# Requires nginx &amp;gt;= 1.3.7
&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;add_header&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Strict&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Transport&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Security&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;max-age=15768000; preload;&quot;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;always&lt;/span&gt;;
    &lt;span class=&quot;n&quot;&gt;add_header&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Referrer&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Policy&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;no-referrer&quot;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;always&lt;/span&gt;;
    &lt;span class=&quot;n&quot;&gt;add_header&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Content&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Type&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Options&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;nosniff&quot;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;always&lt;/span&gt;;
    &lt;span class=&quot;n&quot;&gt;add_header&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Download&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Options&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;noopen&quot;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;always&lt;/span&gt;;
    &lt;span class=&quot;n&quot;&gt;add_header&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Frame&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Options&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;SAMEORIGIN&quot;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;always&lt;/span&gt;;
    &lt;span class=&quot;n&quot;&gt;add_header&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Permitted&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Cross&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Domain&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Policies&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;none&quot;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;always&lt;/span&gt;;
    &lt;span class=&quot;n&quot;&gt;add_header&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Robots&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Tag&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;none&quot;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;always&lt;/span&gt;;
    &lt;span class=&quot;n&quot;&gt;add_header&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;XSS&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Protection&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;1; mode=block&quot;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;always&lt;/span&gt;;

    &lt;span class=&quot;c&quot;&gt;# Remove X-Powered-By, which is an information leak
&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;fastcgi_hide_header&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Powered&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;By&lt;/span&gt;;

    &lt;span class=&quot;c&quot;&gt;# Path to the root of your installation
&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;root&lt;/span&gt; /&lt;span class=&quot;n&quot;&gt;var&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;www&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;nextcloud&lt;/span&gt;;

    &lt;span class=&quot;n&quot;&gt;location&lt;/span&gt; = /&lt;span class=&quot;n&quot;&gt;robots&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;txt&lt;/span&gt; {
        &lt;span class=&quot;n&quot;&gt;allow&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;all&lt;/span&gt;;
        &lt;span class=&quot;n&quot;&gt;log_not_found&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;off&lt;/span&gt;;
        &lt;span class=&quot;n&quot;&gt;access_log&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;off&lt;/span&gt;;
    }

    &lt;span class=&quot;n&quot;&gt;location&lt;/span&gt; = /.&lt;span class=&quot;n&quot;&gt;well&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;known&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;carddav&lt;/span&gt; {
      &lt;span class=&quot;c&quot;&gt;#return 301 $scheme://$host:$server_port/remote.php/dav;
&lt;/span&gt;      &lt;span class=&quot;n&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;301&lt;/span&gt; $&lt;span class=&quot;n&quot;&gt;scheme&lt;/span&gt;://$&lt;span class=&quot;n&quot;&gt;host&lt;/span&gt;:&lt;span class=&quot;m&quot;&gt;444&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;remote&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;php&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;dav&lt;/span&gt;;
    }
    &lt;span class=&quot;n&quot;&gt;location&lt;/span&gt; = /.&lt;span class=&quot;n&quot;&gt;well&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;known&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;caldav&lt;/span&gt; {
      &lt;span class=&quot;c&quot;&gt;#return 301 $scheme://$host:$server_port/remote.php/dav;
&lt;/span&gt;      &lt;span class=&quot;n&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;301&lt;/span&gt; $&lt;span class=&quot;n&quot;&gt;scheme&lt;/span&gt;://$&lt;span class=&quot;n&quot;&gt;host&lt;/span&gt;:&lt;span class=&quot;m&quot;&gt;444&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;remote&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;php&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;dav&lt;/span&gt;;
    }

    &lt;span class=&quot;c&quot;&gt;# set max upload size
&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;client_max_body_size&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;512&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;M&lt;/span&gt;;
    &lt;span class=&quot;n&quot;&gt;fastcgi_buffers&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;64&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;K&lt;/span&gt;;

    &lt;span class=&quot;c&quot;&gt;# Enable gzip but do not remove ETag headers
&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;gzip&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;on&lt;/span&gt;;
    &lt;span class=&quot;n&quot;&gt;gzip_vary&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;on&lt;/span&gt;;
    &lt;span class=&quot;n&quot;&gt;gzip_comp_level&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;4&lt;/span&gt;;
    &lt;span class=&quot;n&quot;&gt;gzip_min_length&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;256&lt;/span&gt;;
    &lt;span class=&quot;n&quot;&gt;gzip_proxied&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;expired&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;no&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;cache&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;no&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;store&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;no_last_modified&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;no_etag&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;auth&lt;/span&gt;;
    &lt;span class=&quot;n&quot;&gt;gzip_types&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;application&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;atom&lt;/span&gt;+&lt;span class=&quot;n&quot;&gt;xml&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;application&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;javascript&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;application&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;json&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;application&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;ld&lt;/span&gt;+&lt;span class=&quot;n&quot;&gt;json&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;application&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;manifest&lt;/span&gt;+&lt;span class=&quot;n&quot;&gt;json&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;application&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;rss&lt;/span&gt;+&lt;span class=&quot;n&quot;&gt;xml&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;application&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;vnd&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;geo&lt;/span&gt;+&lt;span class=&quot;n&quot;&gt;json&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;application&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;vnd&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;ms&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;fontobject&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;application&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;font&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;ttf&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;application&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;web&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;app&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;manifest&lt;/span&gt;+&lt;span class=&quot;n&quot;&gt;json&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;application&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;xhtml&lt;/span&gt;+&lt;span class=&quot;n&quot;&gt;xml&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;application&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;xml&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;font&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;opentype&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;bmp&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;svg&lt;/span&gt;+&lt;span class=&quot;n&quot;&gt;xml&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;icon&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;text&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;cache&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;manifest&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;text&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;css&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;text&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;plain&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;text&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;vcard&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;text&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;vnd&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;rim&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;location&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;xloc&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;text&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;vtt&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;text&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;component&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;text&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;cross&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;domain&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;policy&lt;/span&gt;;

    &lt;span class=&quot;c&quot;&gt;# Uncomment if your server is build with the ngx_pagespeed module
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;# This module is currently not supported.
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;#pagespeed off;
&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;location&lt;/span&gt; / {
        &lt;span class=&quot;n&quot;&gt;rewrite&lt;/span&gt; ^ /&lt;span class=&quot;n&quot;&gt;index&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;php&lt;/span&gt;;
    }

    &lt;span class=&quot;n&quot;&gt;location&lt;/span&gt; ~ ^\/(?:&lt;span class=&quot;n&quot;&gt;build&lt;/span&gt;|&lt;span class=&quot;n&quot;&gt;tests&lt;/span&gt;|&lt;span class=&quot;n&quot;&gt;config&lt;/span&gt;|&lt;span class=&quot;n&quot;&gt;lib&lt;/span&gt;|&lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rdparty&lt;/span&gt;|&lt;span class=&quot;n&quot;&gt;templates&lt;/span&gt;|&lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;)\/ {
        &lt;span class=&quot;n&quot;&gt;deny&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;all&lt;/span&gt;;
    }
    &lt;span class=&quot;n&quot;&gt;location&lt;/span&gt; ~ ^\/(?:\.|&lt;span class=&quot;n&quot;&gt;autotest&lt;/span&gt;|&lt;span class=&quot;n&quot;&gt;occ&lt;/span&gt;|&lt;span class=&quot;n&quot;&gt;issue&lt;/span&gt;|&lt;span class=&quot;n&quot;&gt;indie&lt;/span&gt;|&lt;span class=&quot;n&quot;&gt;db_&lt;/span&gt;|&lt;span class=&quot;n&quot;&gt;console&lt;/span&gt;) {
        &lt;span class=&quot;n&quot;&gt;deny&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;all&lt;/span&gt;;
    }

    &lt;span class=&quot;n&quot;&gt;location&lt;/span&gt; ~ ^\/(?:&lt;span class=&quot;n&quot;&gt;index&lt;/span&gt;|&lt;span class=&quot;n&quot;&gt;remote&lt;/span&gt;|&lt;span class=&quot;n&quot;&gt;public&lt;/span&gt;|&lt;span class=&quot;n&quot;&gt;cron&lt;/span&gt;|&lt;span class=&quot;n&quot;&gt;core&lt;/span&gt;\/&lt;span class=&quot;n&quot;&gt;ajax&lt;/span&gt;\/&lt;span class=&quot;n&quot;&gt;update&lt;/span&gt;|&lt;span class=&quot;n&quot;&gt;status&lt;/span&gt;|&lt;span class=&quot;n&quot;&gt;ocs&lt;/span&gt;\/&lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;[&lt;span class=&quot;m&quot;&gt;12&lt;/span&gt;]|&lt;span class=&quot;n&quot;&gt;updater&lt;/span&gt;\/.+|&lt;span class=&quot;n&quot;&gt;oc&lt;/span&gt;[&lt;span class=&quot;n&quot;&gt;ms&lt;/span&gt;]-&lt;span class=&quot;n&quot;&gt;provider&lt;/span&gt;\/.+|.+\/&lt;span class=&quot;n&quot;&gt;richdocumentscode&lt;/span&gt;\/&lt;span class=&quot;n&quot;&gt;proxy&lt;/span&gt;)\.&lt;span class=&quot;n&quot;&gt;php&lt;/span&gt;(?:$|\/) {
        &lt;span class=&quot;n&quot;&gt;fastcgi_split_path_info&lt;/span&gt; ^(.+?\.&lt;span class=&quot;n&quot;&gt;php&lt;/span&gt;)(\/.*|)$;
        &lt;span class=&quot;n&quot;&gt;set&lt;/span&gt; $&lt;span class=&quot;n&quot;&gt;path_info&lt;/span&gt; $&lt;span class=&quot;n&quot;&gt;fastcgi_path_info&lt;/span&gt;;
        &lt;span class=&quot;n&quot;&gt;try_files&lt;/span&gt; $&lt;span class=&quot;n&quot;&gt;fastcgi_script_name&lt;/span&gt; =&lt;span class=&quot;m&quot;&gt;404&lt;/span&gt;;
        &lt;span class=&quot;n&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fastcgi_params&lt;/span&gt;;
        &lt;span class=&quot;n&quot;&gt;fastcgi_param&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SCRIPT_FILENAME&lt;/span&gt; $&lt;span class=&quot;n&quot;&gt;document_root&lt;/span&gt;$&lt;span class=&quot;n&quot;&gt;fastcgi_script_name&lt;/span&gt;;
        &lt;span class=&quot;n&quot;&gt;fastcgi_param&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PATH_INFO&lt;/span&gt; $&lt;span class=&quot;n&quot;&gt;path_info&lt;/span&gt;;
        &lt;span class=&quot;n&quot;&gt;fastcgi_param&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;HTTPS&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;on&lt;/span&gt;;
        &lt;span class=&quot;c&quot;&gt;# Avoid sending the security headers twice
&lt;/span&gt;        &lt;span class=&quot;n&quot;&gt;fastcgi_param&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;modHeadersAvailable&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;true&lt;/span&gt;;
        &lt;span class=&quot;c&quot;&gt;# Enable pretty urls
&lt;/span&gt;        &lt;span class=&quot;n&quot;&gt;fastcgi_param&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;front_controller_active&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;true&lt;/span&gt;;
        &lt;span class=&quot;n&quot;&gt;fastcgi_pass&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;php&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;handler&lt;/span&gt;;
        &lt;span class=&quot;n&quot;&gt;fastcgi_intercept_errors&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;on&lt;/span&gt;;
        &lt;span class=&quot;n&quot;&gt;fastcgi_request_buffering&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;off&lt;/span&gt;;
    }

    &lt;span class=&quot;n&quot;&gt;location&lt;/span&gt; ~ ^\/(?:&lt;span class=&quot;n&quot;&gt;updater&lt;/span&gt;|&lt;span class=&quot;n&quot;&gt;oc&lt;/span&gt;[&lt;span class=&quot;n&quot;&gt;ms&lt;/span&gt;]-&lt;span class=&quot;n&quot;&gt;provider&lt;/span&gt;)(?:$|\/) {
        &lt;span class=&quot;n&quot;&gt;try_files&lt;/span&gt; $&lt;span class=&quot;n&quot;&gt;uri&lt;/span&gt;/ =&lt;span class=&quot;m&quot;&gt;404&lt;/span&gt;;
        &lt;span class=&quot;n&quot;&gt;index&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;index&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;php&lt;/span&gt;;
    }

    &lt;span class=&quot;c&quot;&gt;# Adding the cache control header for js, css and map files
&lt;/span&gt;    &lt;span class=&quot;c&quot;&gt;# Make sure it is BELOW the PHP block
&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;location&lt;/span&gt; ~ \.(?:&lt;span class=&quot;n&quot;&gt;css&lt;/span&gt;|&lt;span class=&quot;n&quot;&gt;js&lt;/span&gt;|&lt;span class=&quot;n&quot;&gt;woff2&lt;/span&gt;?|&lt;span class=&quot;n&quot;&gt;svg&lt;/span&gt;|&lt;span class=&quot;n&quot;&gt;gif&lt;/span&gt;|&lt;span class=&quot;n&quot;&gt;map&lt;/span&gt;)$ {
        &lt;span class=&quot;n&quot;&gt;try_files&lt;/span&gt; $&lt;span class=&quot;n&quot;&gt;uri&lt;/span&gt; /&lt;span class=&quot;n&quot;&gt;index&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;php&lt;/span&gt;$&lt;span class=&quot;n&quot;&gt;request_uri&lt;/span&gt;;
        &lt;span class=&quot;n&quot;&gt;add_header&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Cache&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Control&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;public, max-age=15778463&quot;&lt;/span&gt;;
        &lt;span class=&quot;c&quot;&gt;# Add headers to serve security related headers (It is intended to
&lt;/span&gt;        &lt;span class=&quot;c&quot;&gt;# have those duplicated to the ones above)
&lt;/span&gt;        &lt;span class=&quot;c&quot;&gt;# Before enabling Strict-Transport-Security headers please read into
&lt;/span&gt;        &lt;span class=&quot;c&quot;&gt;# this topic first.
&lt;/span&gt;        &lt;span class=&quot;c&quot;&gt;#add_header Strict-Transport-Security &quot;max-age=15768000; includeSubDomains; preload;&quot; always;
&lt;/span&gt;        &lt;span class=&quot;c&quot;&gt;#
&lt;/span&gt;        &lt;span class=&quot;c&quot;&gt;# WARNING: Only add the preload option once you read about
&lt;/span&gt;        &lt;span class=&quot;c&quot;&gt;# the consequences in https://hstspreload.org/. This option
&lt;/span&gt;        &lt;span class=&quot;c&quot;&gt;# will add the domain to a hardcoded list that is shipped
&lt;/span&gt;        &lt;span class=&quot;c&quot;&gt;# in all major browsers and getting removed from this list
&lt;/span&gt;        &lt;span class=&quot;c&quot;&gt;# could take several months.
&lt;/span&gt;        &lt;span class=&quot;n&quot;&gt;add_header&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Referrer&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Policy&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;no-referrer&quot;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;always&lt;/span&gt;;
        &lt;span class=&quot;n&quot;&gt;add_header&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Content&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Type&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Options&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;nosniff&quot;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;always&lt;/span&gt;;
        &lt;span class=&quot;n&quot;&gt;add_header&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Download&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Options&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;noopen&quot;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;always&lt;/span&gt;;
        &lt;span class=&quot;n&quot;&gt;add_header&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Frame&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Options&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;SAMEORIGIN&quot;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;always&lt;/span&gt;;
        &lt;span class=&quot;n&quot;&gt;add_header&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Permitted&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Cross&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Domain&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Policies&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;none&quot;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;always&lt;/span&gt;;
        &lt;span class=&quot;n&quot;&gt;add_header&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Robots&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Tag&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;none&quot;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;always&lt;/span&gt;;
        &lt;span class=&quot;n&quot;&gt;add_header&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;XSS&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Protection&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;1; mode=block&quot;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;always&lt;/span&gt;;

        &lt;span class=&quot;c&quot;&gt;# Optional: Don't log access to assets
&lt;/span&gt;        &lt;span class=&quot;n&quot;&gt;access_log&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;off&lt;/span&gt;;
    }

    &lt;span class=&quot;n&quot;&gt;location&lt;/span&gt; ~ \.(?:&lt;span class=&quot;n&quot;&gt;png&lt;/span&gt;|&lt;span class=&quot;n&quot;&gt;html&lt;/span&gt;|&lt;span class=&quot;n&quot;&gt;ttf&lt;/span&gt;|&lt;span class=&quot;n&quot;&gt;ico&lt;/span&gt;|&lt;span class=&quot;n&quot;&gt;jpg&lt;/span&gt;|&lt;span class=&quot;n&quot;&gt;jpeg&lt;/span&gt;|&lt;span class=&quot;n&quot;&gt;bcmap&lt;/span&gt;|&lt;span class=&quot;n&quot;&gt;mp4&lt;/span&gt;|&lt;span class=&quot;n&quot;&gt;webm&lt;/span&gt;)$ {
        &lt;span class=&quot;n&quot;&gt;try_files&lt;/span&gt; $&lt;span class=&quot;n&quot;&gt;uri&lt;/span&gt; /&lt;span class=&quot;n&quot;&gt;index&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;php&lt;/span&gt;$&lt;span class=&quot;n&quot;&gt;request_uri&lt;/span&gt;;
        &lt;span class=&quot;c&quot;&gt;# Optional: Don't log access to other assets
&lt;/span&gt;        &lt;span class=&quot;n&quot;&gt;access_log&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;off&lt;/span&gt;;
    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;installing-and-configuring-apache&quot;&gt;Installing and Configuring Apache&lt;/h2&gt;
&lt;p&gt;If you instead prefer Apache, here is the configuration required to work. More information can be found at &lt;a href=&quot;https://docs.nextcloud.com/server/latest/admin_manual/installation/source_installation.html#apache-web-server-configuration&quot;&gt;Nextcloud Documentation&lt;/a&gt;.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Don’t forget to replace &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$YOUR_DOMAIN_NAME&lt;/code&gt; by your domain name in the configuration given below.&lt;/li&gt;
  &lt;li&gt;This will give you an A+ score at SSL Labs. It needs a Let’s Encrypt SSL Certificate generation, covered in Part 4.&lt;/li&gt;
  &lt;li&gt;I’ve replaced the SSL Certificates path with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/path/to/XXX&lt;/code&gt; for now.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;You need to activate a few additonal modules:&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;a2enmod rewrite
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;a2enmod headers
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;a2enmod &lt;span class=&quot;nb&quot;&gt;env&lt;/span&gt;     &lt;span class=&quot;c&quot;&gt;# already enabled&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;a2enmod &lt;span class=&quot;nb&quot;&gt;dir&lt;/span&gt;     &lt;span class=&quot;c&quot;&gt;# already enabled&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;a2enmod mime    &lt;span class=&quot;c&quot;&gt;# already enabled&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;a2enmod ssl
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Remove default configuration file and create a new one for Nextcloud:&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;a2dissite 000-default.conf
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;a2dissite default-ssl.conf

&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;vim &lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;/etc/apache2/sites-available/nextcloud.conf&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Apache configuration file content:&lt;/p&gt;
&lt;div class=&quot;language-conf highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;SSLUseStapling&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;on&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;SSLStaplingCache&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;shmcb:logs/stapling-cache(150000)&quot;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;ServerName&lt;/span&gt; $&lt;span class=&quot;n&quot;&gt;YOUR_DOMAIN_NAME&lt;/span&gt;
&amp;lt;&lt;span class=&quot;n&quot;&gt;VirtualHost&lt;/span&gt; *:&lt;span class=&quot;m&quot;&gt;443&lt;/span&gt;&amp;gt;

  &lt;span class=&quot;n&quot;&gt;Alias&lt;/span&gt; / &lt;span class=&quot;s2&quot;&gt;&quot;/var/www/nextcloud/&quot;&lt;/span&gt;

  &amp;lt;&lt;span class=&quot;n&quot;&gt;Directory&lt;/span&gt; /&lt;span class=&quot;n&quot;&gt;var&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;www&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;nextcloud&lt;/span&gt;/&amp;gt;
    &lt;span class=&quot;n&quot;&gt;Options&lt;/span&gt; +&lt;span class=&quot;n&quot;&gt;FollowSymlinks&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;AllowOverride&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;All&lt;/span&gt;

   &amp;lt;&lt;span class=&quot;n&quot;&gt;IfModule&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mod_dav&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&amp;gt;
    &lt;span class=&quot;n&quot;&gt;Dav&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;off&lt;/span&gt;
   &amp;lt;/&lt;span class=&quot;n&quot;&gt;IfModule&lt;/span&gt;&amp;gt;

   &lt;span class=&quot;n&quot;&gt;SetEnv&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;HOME&lt;/span&gt; /&lt;span class=&quot;n&quot;&gt;var&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;www&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;nextcloud&lt;/span&gt;
   &lt;span class=&quot;n&quot;&gt;SetEnv&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;HTTP_HOME&lt;/span&gt; /&lt;span class=&quot;n&quot;&gt;var&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;www&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;nextcloud&lt;/span&gt;
  &amp;lt;/&lt;span class=&quot;n&quot;&gt;Directory&lt;/span&gt;&amp;gt;

  &lt;span class=&quot;c&quot;&gt;# TLS CONFIGURATION
&lt;/span&gt;  &lt;span class=&quot;c&quot;&gt;# We'll update this shortly (see PART 4)
&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;SSLEngine&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;on&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;SSLCertificateFile&lt;/span&gt; /&lt;span class=&quot;n&quot;&gt;path&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;to&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;fullchain&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;cer&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;SSLCertificateKeyFile&lt;/span&gt; /&lt;span class=&quot;n&quot;&gt;path&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;to&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;private_key&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;key&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;SSLOpenSSLConfCmd&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;DHParameters&lt;/span&gt; /&lt;span class=&quot;n&quot;&gt;path&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;to&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;dhparam&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;pem&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;SSLCipherSuite&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;EECDH&lt;/span&gt;+&lt;span class=&quot;n&quot;&gt;AESGCM&lt;/span&gt;:&lt;span class=&quot;n&quot;&gt;EDH&lt;/span&gt;+&lt;span class=&quot;n&quot;&gt;AESGCM&lt;/span&gt;:&lt;span class=&quot;n&quot;&gt;AES256&lt;/span&gt;+&lt;span class=&quot;n&quot;&gt;EECDH&lt;/span&gt;:&lt;span class=&quot;n&quot;&gt;AES256&lt;/span&gt;+&lt;span class=&quot;n&quot;&gt;EDH&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;SSLProtocol&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;All&lt;/span&gt; -&lt;span class=&quot;n&quot;&gt;SSLv2&lt;/span&gt; -&lt;span class=&quot;n&quot;&gt;SSLv3&lt;/span&gt; -&lt;span class=&quot;n&quot;&gt;TLSv1&lt;/span&gt; -&lt;span class=&quot;n&quot;&gt;TLSv1&lt;/span&gt;.&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;SSLHonorCipherOrder&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;On&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;SSLCompression&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;off&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;SSLSessionTickets&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Off&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;Header&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;always&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Strict&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Transport&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;Security&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;max-age=63072000; preload&quot;&lt;/span&gt;
  &lt;span class=&quot;c&quot;&gt;# Not needed, set by NextCloud in /var/www/nextcloud/.htaccess file :
&lt;/span&gt;  &lt;span class=&quot;c&quot;&gt;# Header always set X-Frame-Options DENY # → Seem to be configured elsewhere
&lt;/span&gt;  &lt;span class=&quot;c&quot;&gt;# Header always set X-Content-Type-Options nosniff
&lt;/span&gt;&amp;lt;/&lt;span class=&quot;n&quot;&gt;VirtualHost&lt;/span&gt;&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Enable the website:&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;a2ensite nextcloud
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;configuring-nextcloud&quot;&gt;Configuring Nextcloud&lt;/h2&gt;
&lt;p&gt;At this stage you have a basic installation and a server in front of it. It’s time to fine tune Nextcloud.&lt;/p&gt;

&lt;h4 id=&quot;fine-tuning-configphp&quot;&gt;Fine tuning config.php&lt;/h4&gt;
&lt;p&gt;Nextcloud config file is at &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/www/nextcloud/config/config.php&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# I'm only listing the not default options
&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$CONFIG&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;array&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
  &lt;span class=&quot;s1&quot;&gt;'trusted_domains'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;array&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# 0 =&amp;gt; 'localhost',       # → remove this&lt;/span&gt;
    &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'192.168.1.XXX'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;     &lt;span class=&quot;c1&quot;&gt;# Target's local network address&lt;/span&gt;
    &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'$YOUR_DOMAIN_NAME'&lt;/span&gt;  &lt;span class=&quot;c1&quot;&gt;# You domain name&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;'tempdirectory'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'/media/data/nextcloud_tmp_dir'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# Support big files (see below)&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;'memcache.local'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'\OC\Memcache\APCu'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;            &lt;span class=&quot;c1&quot;&gt;# APCU cache support&lt;/span&gt;
&lt;span class=&quot;s1&quot;&gt;'config_is_read_only'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;supporting-big-files&quot;&gt;Supporting Big files&lt;/h4&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;Find the appropriate &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;php.ini&lt;/code&gt; file.
According to &lt;a href=&quot;https://docs.nextcloud.com/server/latest/admin_manual/installation/source_installation.html#php-ini-configuration-notes&quot;&gt;this Doc&lt;/a&gt;, the appropriate files are different if you run Nginx or Apache, and if you are running PHP from the command line (including CRON) or from the server!&lt;/p&gt;

    &lt;ul&gt;
      &lt;li&gt;
        &lt;p&gt;Nginx: files are located here:&lt;/p&gt;

        &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;/etc/php/7.3/fpm/php.ini
/etc/php/7.3/fpm/pool.d/www.conf
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;        &lt;/div&gt;
      &lt;/li&gt;
      &lt;li&gt;
        &lt;p&gt;Apache: files are located here:&lt;/p&gt;

        &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# php.ini - used by the Web server:&lt;/span&gt;
/etc/php/7.3/apache2/php.ini
&lt;span class=&quot;c&quot;&gt;# php.ini - used by the php-cli and so by Nextcloud CRON jobs:&lt;/span&gt;
/etc/php/7.3/cli/php.ini
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;        &lt;/div&gt;
        &lt;p&gt;Running &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;php --ini&lt;/code&gt; will give you which&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;php.ini&lt;/code&gt; file is used, but this is only valid for the CLI, it might NOT be the same one used by the server!&lt;/p&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Edit the appropriate &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;php.ini&lt;/code&gt; file:&lt;/p&gt;
    &lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;upload_max_filesize&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;G&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;post_max_size&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;16&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;G&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;output_buffering&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;memory_limit&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;512&lt;/span&gt;&lt;span class=&quot;nc&quot;&gt;M&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# Max time before timeout (in s)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;max_input_time&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;7200&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;max_execution_time&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;7200&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
    &lt;p&gt;Source: &lt;a href=&quot;https://docs.nextcloud.com/server/latest/admin_manual/configuration_files/big_file_upload_configuration.html#configuring-php&quot;&gt;Nextcloud Doc&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h4 id=&quot;enabling-apcu-cache&quot;&gt;Enabling APCu Cache&lt;/h4&gt;
&lt;p&gt;Enable &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;apc&lt;/code&gt; in the appropriate &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;php.ini&lt;/code&gt; file:&lt;/p&gt;
&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;apc&lt;/span&gt;&lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;enable_cli&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Source: &lt;a href=&quot;https://docs.nextcloud.com/server/latest/admin_manual/configuration_server/caching_configuration.html#id1&quot;&gt;Nextcloud Doc&lt;/a&gt;&lt;/p&gt;

&lt;h5 id=&quot;bigint-64bit-identifiers&quot;&gt;BigInt (64bit) identifiers&lt;/h5&gt;
&lt;p&gt;Some tables primary keys are now BigInt, but Nextcloud doesn’t convert them automatically as it can take hours. Follow the command line described &lt;a href=&quot;https://docs.nextcloud.com/server/latest/admin_manual/configuration_database/bigint_identifiers.html&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;next&quot;&gt;Next&lt;/h2&gt;
&lt;p&gt;TLS certificates and DNS resolution, see &lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part4&quot;&gt;PART 4&lt;/a&gt;&lt;/p&gt;</content><author><name></name></author><category term="nextcloud" /><summary type="html">See also PART 1 PART 2 PART 3 ← You are here 🙂 PART 4 PART 5</summary></entry><entry><title type="html">[5/5] Self hosted Nextcloud 20+</title><link href="/self-hosted-nextcloud-on-sbc-complete-guide-part5" rel="alternate" type="text/html" title="[5/5] Self hosted Nextcloud 20+" /><published>2021-03-23T10:30:00+00:00</published><updated>2021-03-23T10:30:00+00:00</updated><id>/complete-guide-to-self-hosted-nextcloud-part5</id><content type="html" xml:base="/self-hosted-nextcloud-on-sbc-complete-guide-part5">&lt;h2 id=&quot;see-also&quot;&gt;See also&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part1&quot;&gt;PART 1&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part2&quot;&gt;PART 2&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part3&quot;&gt;PART 3&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part4&quot;&gt;PART 4&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;PART 5 ← You are here 🙂&lt;/li&gt;
&lt;/ul&gt;

&lt;p class=&quot;info&quot;&gt;
  🏗️ This part deals with maintenance burden. Not the funniest part but always needed to ensure a healthy system. I've divided the sections as if they were 'flight rules', they aren't meant to be read sequentially.
&lt;/p&gt;

&lt;h2 id=&quot;remounting-as-a-readwrite-fs&quot;&gt;Remounting as a read/write FS&lt;/h2&gt;
&lt;p&gt;When updates are needed or simply updating the configuration is needed, one could need to temporarily deactivate the read only filesystem.&lt;/p&gt;

&lt;p&gt;Although &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;overlayroot&lt;/code&gt; package gives an &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;overlayroot-chroot&lt;/code&gt; command, don’t use it for two reasons:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;The &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/media/root-ro&lt;/code&gt; directory is remounted as &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ro&lt;/code&gt; and changes wouldn’t persist&lt;/li&gt;
  &lt;li&gt;Packages updates / installation might break because some operations are forbidden in chrooted environment. You might experience some &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Running in chroot, ignoring request.&lt;/code&gt; errors.&lt;/li&gt;
&lt;/ol&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;mount &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; remount,defaults,noatime,rw &lt;span class=&quot;nt&quot;&gt;-t&lt;/span&gt; ext4 /dev/mmcblk0p2 /media/root-ro

&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;vim /media/root-ro/etc/overlayroot.local.conf
&lt;span class=&quot;c&quot;&gt;# → Add '#' before `overlayroot=&quot;tmpfs:swap=1,recurse=0&quot;` line&lt;/span&gt;

&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;reboot
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;updating-nextcloud&quot;&gt;Updating Nextcloud&lt;/h2&gt;

&lt;ol&gt;
  &lt;li&gt;Remount the filesystem as read/write (see above) and reboot&lt;/li&gt;
  &lt;li&gt;Upgrade Nextcloud from the command line:
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;  &lt;span class=&quot;nb&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; www-data php /var/www/nextcloud/updater/updater.phar  &lt;span class=&quot;nt&quot;&gt;--no-interaction&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
    &lt;p&gt;&lt;a href=&quot;https://docs.nextcloud.com/server/18/admin_manual/maintenance/update.html#using-the-command-line-based-updater&quot;&gt;See Offical Doc&lt;/a&gt;&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;Remount the system in readonly mode
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;vim /etc/overlayroot.local.conf &lt;span class=&quot;c&quot;&gt;# uncomment the line&lt;/span&gt;
 &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;reboot
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;updating-the-kernel&quot;&gt;Updating the Kernel&lt;/h2&gt;
&lt;p&gt;If you recompiled your kernel in Part 2, you’ll have to recompile it regularly to keep it up to date.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;
    &lt;p&gt;Compile kernel sources&lt;/p&gt;

    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# On the HOST machine&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# Assuming you still have a linux git clone from part 2&lt;/span&gt;
git branch &lt;span class=&quot;c&quot;&gt;# Will tell you on which branch you currently are&lt;/span&gt;
git pull origin linux-5.4.y

&lt;span class=&quot;c&quot;&gt;# Restart incremental compilation&lt;/span&gt;
make zImage &lt;span class=&quot;nv&quot;&gt;ARCH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;arm &lt;span class=&quot;nv&quot;&gt;CROSS_COMPILE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;arm-linux-gnueabihf- &lt;span class=&quot;nt&quot;&gt;-j16&lt;/span&gt;
make modules &lt;span class=&quot;nv&quot;&gt;ARCH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;arm &lt;span class=&quot;nv&quot;&gt;CROSS_COMPILE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;arm-linux-gnueabihf- &lt;span class=&quot;nt&quot;&gt;-j16&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# Compile the DTS (should not be necessary)&lt;/span&gt;
make &lt;span class=&quot;nv&quot;&gt;ARCH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;arm rk3288-tinker.dtb &lt;span class=&quot;nv&quot;&gt;CROSS_COMPILE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;arm-linux-gnueabihf- &lt;span class=&quot;nt&quot;&gt;-j8&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# Transfer to SDCard&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# Installing drivers on SD Card&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;make &lt;span class=&quot;nv&quot;&gt;ARCH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;arm &lt;span class=&quot;nv&quot;&gt;INSTALL_MOD_PATH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/media/&lt;span class=&quot;nv&quot;&gt;$USER&lt;/span&gt;/324cd421-b656-4326-9882-de35a3ad335a/ modules_install

&lt;span class=&quot;c&quot;&gt;# Installing on the target's /boot partition&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;cp arch&lt;/span&gt;/arm/boot/zImage /media/&lt;span class=&quot;nv&quot;&gt;$USER&lt;/span&gt;/4C89-2DED/
&lt;span class=&quot;nb&quot;&gt;cp arch&lt;/span&gt;/arm/boot/dts/rk3288-miniarm.dtb /media/&lt;span class=&quot;nv&quot;&gt;$USER&lt;/span&gt;/4C89-2DED/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;When rebooting, recreate an &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;initframfs&lt;/code&gt;:&lt;/p&gt;

    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;En bootant, refaire un initrd:
su root
&lt;span class=&quot;nb&quot;&gt;export &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;PATH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/usr/sbin:&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$PATH&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
update-initramfs &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-k&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;uname&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-r&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# This will create an initrd in /boot (ex: &quot;initrd.img-5.4.94+&quot;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;You’ll have to update the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/boot/extlinux/extlinux.conf&lt;/code&gt; file with the two new files.&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;backing-up-your-sd-card&quot;&gt;Backing up your SD Card&lt;/h2&gt;
&lt;ol&gt;
  &lt;li&gt;Put your SD Card in your host pc&lt;/li&gt;
  &lt;li&gt;Umount it manually&lt;/li&gt;
  &lt;li&gt;Launch a terminal and type:
    &lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;  &lt;span class=&quot;nb&quot;&gt;sudo dd &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/dev/mmcblk0 &lt;span class=&quot;nv&quot;&gt;conv&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;sync&lt;/span&gt;,noerror &lt;span class=&quot;nv&quot;&gt;bs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;64K | &lt;span class=&quot;nb&quot;&gt;gzip&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; /PATH/TO/DRIVE/backup_image.img.gz
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
    &lt;p&gt;(adapt &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;mmcblk0&lt;/code&gt; with your SD Card actual dev name)&lt;/p&gt;
  &lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&quot;restoring-a-backup&quot;&gt;Restoring a backup&lt;/h2&gt;
&lt;p&gt;Same procedure but goes the other way round:&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;  &lt;span class=&quot;nb&quot;&gt;gunzip  &lt;/span&gt;backup_image.img.gz
  &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;sh &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'cat backup_image.img &amp;gt; /dev/mmcblk0'&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;(again, adapt &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;mmcblk0&lt;/code&gt; with your SD Card actual dev name)&lt;/p&gt;</content><author><name></name></author><category term="nextcloud" /><summary type="html">See also PART 1 PART 2 PART 3 PART 4 PART 5 ← You are here 🙂</summary></entry><entry><title type="html">[4/5] Self hosted Nextcloud 20+</title><link href="/self-hosted-nextcloud-on-sbc-complete-guide-part4" rel="alternate" type="text/html" title="[4/5] Self hosted Nextcloud 20+" /><published>2021-03-23T10:30:00+00:00</published><updated>2021-03-23T10:30:00+00:00</updated><id>/complete-guide-to-self-hosted-nextcloud-part4</id><content type="html" xml:base="/self-hosted-nextcloud-on-sbc-complete-guide-part4">&lt;h2 id=&quot;see-also&quot;&gt;See also&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part1&quot;&gt;PART 1&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part2&quot;&gt;PART 2&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part3&quot;&gt;PART 3&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;PART 4 ← You are here 🙂&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part5&quot;&gt;PART 5&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p class=&quot;info&quot;&gt;
  🎯 This part deals with TLS certificate generation (wildcard) and DNS client configuration. You are next to the end!
&lt;/p&gt;

&lt;h2 id=&quot;lets-encrypt-tls-certificate&quot;&gt;Let’s Encrypt TLS Certificate&lt;/h2&gt;
&lt;p&gt;Your server serves requests à port &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;443&lt;/code&gt;, which is reserved port for &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;https&lt;/code&gt;. It must serve a valid TLS certificate, signed by a third party. Let’s Encrypt is a non profit issuing TLS Certificates for free, which are perfectly valid. At this time of writing, they issue &amp;gt;1.5M certificates per day!&lt;/p&gt;

&lt;p&gt;They conceived an implemented a new protocoel to allow certificate issuance in an automated way. Its second version, ACMEv2, support wildcard certificate types (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;*.mydomain.com&lt;/code&gt;). Neat!&lt;/p&gt;

&lt;p&gt;Various clients appeared on the web to implement the ACME protocol. I tried a few of them but I have to say &lt;a href=&quot;https://github.com/acmesh-official/acme.sh&quot;&gt;acme.sh&lt;/a&gt; is my favourite.&lt;/p&gt;

&lt;h4 id=&quot;generate-ssltls-certificate&quot;&gt;Generate SSL/TLS Certificate&lt;/h4&gt;
&lt;p&gt;In order to issue wildcard certificates, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;acme.sh&lt;/code&gt; needs to be able to write some DNS records to proove it has sufficient permissions to administer the domain name (and its subdomains). This requires an application key + secret from your DNS provider. The procedure diverges from provider to provider but &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;acme.sh&lt;/code&gt; support &lt;a href=&quot;https://github.com/acmesh-official/acme.sh/wiki/dnsapi&quot;&gt;the main ones&lt;/a&gt;, given the credentials.&lt;/p&gt;

&lt;p&gt;I will use OVH as an example because its the one I use and its the #1 in Europe.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# Git clone du logiciel&lt;/span&gt;
git clone https://github.com/acmesh-official/acme.sh.git
&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;acme.sh

&lt;span class=&quot;c&quot;&gt;# Get your application + secret keys from your DNS provider.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# I use OVH (leader in Europe), where you can fetch them here:&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# https://eu.api.ovh.com/createApp/&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# Export OVH Application Key&lt;/span&gt;
 &lt;span class=&quot;nb&quot;&gt;export &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;OVH_AK&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;XXX&quot;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# Export OVH Application Secret&lt;/span&gt;
 &lt;span class=&quot;nb&quot;&gt;export &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;OVH_AS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;YYY&quot;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# Start acme.sh with the requested domain name (+ wildcard)&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# See https://github.com/acmesh-official/acme.sh/wiki/dnsapi&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# for per DNS provider instructions&lt;/span&gt;
./acme.sh &lt;span class=&quot;nt&quot;&gt;--issue&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; my-domain.com &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'*.my-domain.com'&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--dns&lt;/span&gt; dns_ovh

&lt;span class=&quot;c&quot;&gt;# acme outputs the files location. Copy the private key path (*.key) and the fullchain path (fullcain.cer)&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# copier les originaux vers sheeva de nextcloud&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# /home/$USER/.acme.sh/my-domain.com/my-domain.com.key&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# /home/$USER/.acme.sh/my-domain.com/fullchain.cer&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;generate-a-custom-dhparams-file&quot;&gt;Generate a custom DHParams file&lt;/h4&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;openssl dhparam &lt;span class=&quot;nt&quot;&gt;-out&lt;/span&gt; /etc/nginx/dhparam.pem 4096
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;update-nginx--apache-configuration&quot;&gt;update Nginx / Apache configuration&lt;/h4&gt;
&lt;p&gt;You can now edit the Nginx / Apache configuration from part 3 with the newly created files:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;Nginx:&lt;/p&gt;

    &lt;div class=&quot;language-conf highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# TLS CONFIGURATION
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ssl_certificate&lt;/span&gt; /&lt;span class=&quot;n&quot;&gt;path&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;to&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;fullchain&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;cer&lt;/span&gt;;
&lt;span class=&quot;n&quot;&gt;ssl_certificate_key&lt;/span&gt; /&lt;span class=&quot;n&quot;&gt;path&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;to&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;private_key&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;key&lt;/span&gt;;
&lt;span class=&quot;n&quot;&gt;ssl_dhparam&lt;/span&gt; /&lt;span class=&quot;n&quot;&gt;path&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;to&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;dhparam&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;pem&lt;/span&gt;;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;Apache:&lt;/p&gt;

    &lt;div class=&quot;language-conf highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# TLS CONFIGURATION
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SSLEngine&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;on&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;SSLCertificateFile&lt;/span&gt; /&lt;span class=&quot;n&quot;&gt;path&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;to&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;fullchain&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;cer&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;SSLCertificateKeyFile&lt;/span&gt; /&lt;span class=&quot;n&quot;&gt;path&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;to&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;private_key&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;key&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;SSLOpenSSLConfCmd&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;DHParameters&lt;/span&gt; /&lt;span class=&quot;n&quot;&gt;path&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;to&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;dhparam&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;pem&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Restart your server and you are good to go: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sudo systemctl restart nginx.service&lt;/code&gt;&lt;/p&gt;

&lt;h2 id=&quot;dynamic-host-via-ddclient&quot;&gt;Dynamic host via ddclient&lt;/h2&gt;
&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ddclient&lt;/code&gt; is a client that updates IPs for dynamic hosts and supports multiple DNS providers. It runs as a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;systemd&lt;/code&gt; daemon so no need for CRON stuff whatsoever!&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;apt &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;ddclient

&lt;span class=&quot;c&quot;&gt;# The install script will ask questions, here are my answers for OVH DNS provider (in FR 🤷)&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#    Fournisseur de service DNS : Other&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#    Serveur de DNS dynamique : www.ovh.com&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#    Protocole de mise à jour : dyndns2&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#    Identifiant pour le service : your-ovh-identifier&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#    Mot de passe : your password&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#    Interface réseau utilisé par le service de DNS : eth0&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#    Nom de domaine de DNS dynamique : your-domain-name.com&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It will already work as is, but it will use the local IP as dynamic resolution. One must update the file &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/ddclient.conf&lt;/code&gt; as follow:&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# Configuration file for ddclient generated by debconf&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# /etc/ddclient.conf&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;daemon&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;5m,                                                         &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;protocol&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;dyndns2,                                                  &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;use&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;web, &lt;span class=&quot;nv&quot;&gt;web&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;checkip.dyndns.com/, web-skip&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'Current IP Address: '&lt;/span&gt;, &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;server&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;www.ovh.com,                                                &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;login&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;your-ovh-identifier,                                       &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;password&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'wildcard'&lt;/span&gt;,                                               &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
you-domain-names.com,comma-separated
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ddclient&lt;/code&gt;’s manapage gives some useful examples: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/usr/sbin/ddclient --help&lt;/code&gt;
&lt;a href=&quot;https://perhonen.fr/blog/2016/03/dynhost-dyndns-de-chez-ovh-2446&quot;&gt;Source [FR]&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;solving-file-download-interruption&quot;&gt;Solving file download interruption&lt;/h2&gt;
&lt;p&gt;If you encounter &lt;a href=&quot;https://github.com/nextcloud/server/issues/5390&quot;&gt;file download interruptions&lt;/a&gt; (even for small files), the root cause might be an Ethernet and known issue of RK3399 (I’ve experienced that on the RK3388 as well).&lt;/p&gt;

&lt;h4 id=&quot;solution-1-disable-offloading&quot;&gt;Solution 1: disable offloading&lt;/h4&gt;
&lt;p&gt;The easiest solution is to deactivate TCP/UDP offloading, as described &lt;a href=&quot;https://unix.stackexchange.com/a/495378&quot;&gt;here&lt;/a&gt; and &lt;a href=&quot;https://github.com/MichaIng/DietPi/issues/2028&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;/sbin/ethtool &lt;span class=&quot;nt&quot;&gt;-K&lt;/span&gt; eth0 rx off tx off
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;make-it-permanent&quot;&gt;Make it permanent&lt;/h5&gt;
&lt;p&gt;To make it permanent, create an if-up script &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/network/if-up.d/disable-offload&lt;/code&gt; with the following content:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/bin/bash&lt;/span&gt;
/sbin/ethtool &lt;span class=&quot;nt&quot;&gt;-K&lt;/span&gt; eth0 rx off tx off
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Don’t forget to make it executable via &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sudo chmod +x /etc/network/if-up.d/disable-offload&lt;/code&gt;!&lt;/p&gt;

&lt;h4 id=&quot;solution-2-patch-kernel-to-the-appropriate-value&quot;&gt;Solution 2: patch kernel to the appropriate value&lt;/h4&gt;
&lt;p&gt;A better solution has been proposed (and merged) in &lt;a href=&quot;https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=8a469ee35606ba65448d54e5a2a23302f7e79e3c&quot;&gt;this commit&lt;/a&gt; for chips RK3328 and RK3399, but it also works with chip RK3288.&lt;/p&gt;

&lt;p&gt;The patch goes like this:&lt;/p&gt;

&lt;div class=&quot;language-patch highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gh&quot;&gt;diff --git arch/arm/boot/dts/rk3288.dtsi arch/arm/boot/dts/rk3288.dtsi
index cc893e154fe5..45d2850f740a 100644
&lt;/span&gt;&lt;span class=&quot;gd&quot;&gt;--- a/arch/arm/boot/dts/rk3288.dtsi
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+++ b/arch/arm/boot/dts/rk3288.dtsi
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;@@ -593,6 +593,7 @@&lt;/span&gt;
                        &quot;aclk_mac&quot;, &quot;pclk_mac&quot;;
                resets = &amp;lt;&amp;amp;cru SRST_MAC&amp;gt;;
                reset-names = &quot;stmmaceth&quot;;
&lt;span class=&quot;gi&quot;&gt;+               snps,txpbl = &amp;lt;0x4&amp;gt;;
&lt;/span&gt;                status = &quot;disabled&quot;;
        };
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Recompile the kernel and enjoy the speed! 😎&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;If you followed until this section you should now have a pretty solid Nextcloud installation. There is of course always room for improvements and I would be thrilled to hear your suggestions! You can always contact me, there are a couple of ways to reach me out listed on the homepage. The Github repo of this blog is &lt;a href=&quot;https://github.com/dvergeylen/dvergeylen.github.io/discussions&quot;&gt;open for discussions&lt;/a&gt;, so don’t hesitate to start one there if you want to discuss about specific topics. Thanks and all the best! 🥂&lt;/p&gt;

&lt;h2 id=&quot;next&quot;&gt;Next&lt;/h2&gt;
&lt;p&gt;There is a 5th ‘Bonus’ part to this blog post series, namely about maintenance tasks, check it out &lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part5&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;</content><author><name></name></author><category term="nextcloud" /><summary type="html">See also PART 1 PART 2 PART 3 PART 4 ← You are here 🙂 PART 5</summary></entry><entry><title type="html">[Javascript] Useful code snippets</title><link href="/javascript-code-snippets" rel="alternate" type="text/html" title="[Javascript] Useful code snippets" /><published>2020-11-26T10:30:00+00:00</published><updated>2020-11-26T10:30:00+00:00</updated><id>/javascript-code-snippets</id><content type="html" xml:base="/javascript-code-snippets">&lt;h4 id=&quot;introduction&quot;&gt;Introduction&lt;/h4&gt;
&lt;p&gt;Here are common Javascript patterns I use all the time, mainly in Svelte apps.
Functional patterns are always easier to reason about and less error prone. You should always favor such patterns, when possible.&lt;/p&gt;

&lt;p&gt;I have written the Ruby equivalent &lt;a href=&quot;/ruby-code-snippets&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;code-snippets&quot;&gt;Code Snippets&lt;/h3&gt;

&lt;h5 id=&quot;filter&quot;&gt;Filter&lt;/h5&gt;
&lt;div class=&quot;language-javascript highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nx&quot;&gt;ar&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;nx&quot;&gt;ar&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;filter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;elem&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;elem&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// ↳ [2, 4, 6]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;map&quot;&gt;Map&lt;/h5&gt;
&lt;div class=&quot;language-javascript highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nx&quot;&gt;ar&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;nx&quot;&gt;ar&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;elem&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;elem&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// ↳ [2, 4, 6, 8, 10, 12]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;reduce&quot;&gt;Reduce&lt;/h5&gt;
&lt;div class=&quot;language-javascript highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;// Reduce&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// trailing '0' is accumulator initial value (ALWAYS set one!)&lt;/span&gt;
&lt;span class=&quot;nx&quot;&gt;ar&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;reduce&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;acc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;elem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;acc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;elem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;nx&quot;&gt;ar&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// ↳ 21&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// Reduce is also useful with hashes...&lt;/span&gt;
&lt;span class=&quot;nx&quot;&gt;hash&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;f&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;keys&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;hash&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;reduce&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;acc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;acc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{...&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;acc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;hash&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]},&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{})&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// ↳ { a: 'b', c: 'd', e: 'f' }&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// ... or grouping by (unknown) keys&lt;/span&gt;
&lt;span class=&quot;nx&quot;&gt;ar_h&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;key1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;key2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;key1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;key2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}]&lt;/span&gt;
&lt;span class=&quot;nx&quot;&gt;ar_h&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;reduce&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;acc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;elem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;({&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;acc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;keys&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;elem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;reduce&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;elemAcc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;({&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;elemAcc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;elemAcc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;elemAcc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;elem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;elem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{}),&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{})&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// ↳ {:key1=&amp;gt;&quot;bd&quot;, :key2=&amp;gt;&quot;ac&quot;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;sort&quot;&gt;Sort&lt;/h5&gt;
&lt;div class=&quot;language-javascript highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;// Sort takes 2 args&lt;/span&gt;
&lt;span class=&quot;nx&quot;&gt;ar&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;nx&quot;&gt;ar&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;sort&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// ↳ [6, 5, 4, 3, 2, 1]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;find&quot;&gt;Find&lt;/h5&gt;
&lt;div class=&quot;language-javascript highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;// Find&lt;/span&gt;
&lt;span class=&quot;nx&quot;&gt;ar_h&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;mykey&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;mykey&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;mykey&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;mykey&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}]&lt;/span&gt;
&lt;span class=&quot;nx&quot;&gt;ar_h&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;find&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;elem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;elem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;mykey&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;d&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// ↳ {mykey: 'd'}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;use-of-concurrent-promises&quot;&gt;Use of concurrent Promises&lt;/h5&gt;
&lt;p&gt;A common misunderstanding is that “&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;node&lt;/code&gt; is single threaded” which is incorrect. &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;node&lt;/code&gt; uses a single Event loop (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;libuv&lt;/code&gt;) yes, but powered by a worker pool (4, by default). More information can be found in &lt;a href=&quot;https://medium.com/@joydipand/how-does-thread-pool-work-in-node-js-c48f3b3662a9&quot;&gt;this blog post&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;This means it’s useful to handle multiple asynchronous operations in parallel, via Promises. Never do this in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.forEach()&lt;/code&gt; statements, though!&lt;/p&gt;

&lt;div class=&quot;language-javascript highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;// forEach&lt;/span&gt;
&lt;span class=&quot;nx&quot;&gt;ar&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;forEach&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;elem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// do stuff...&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// ... but no async function!&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// Because forEach doesn't return something&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;// Use map() instead (see below)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// Promise Example&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// Notice that if at least 1 promise fails,&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// Promise.all will fail as well.&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// ALWAYS wrap Promises in try / catch blocks&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;ar&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;promises&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;ar&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;async&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;elem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;await&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Promise&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;resolve&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;reject&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;setTimeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;resolve&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;elem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;results&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;await&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Promise&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;all&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;promises&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;console&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;results&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;catch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;console&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;})();&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;optional-chaining&quot;&gt;Optional chaining:&lt;/h5&gt;
&lt;div class=&quot;language-javascript highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;// Javascript Optional Chaining:&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// use ?. to navigate safely accross objects:&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;// &amp;lt;p&amp;gt;The item name is: ${item?.name}&amp;lt;/p&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name></name></author><category term="snippets" /><summary type="html">Introduction Here are common Javascript patterns I use all the time, mainly in Svelte apps. Functional patterns are always easier to reason about and less error prone. You should always favor such patterns, when possible.</summary></entry><entry><title type="html">[Ruby] Useful code snippets</title><link href="/ruby-code-snippets" rel="alternate" type="text/html" title="[Ruby] Useful code snippets" /><published>2020-11-26T10:30:00+00:00</published><updated>2020-11-26T10:30:00+00:00</updated><id>/ruby-code-snippets</id><content type="html" xml:base="/ruby-code-snippets">&lt;h4 id=&quot;introduction&quot;&gt;Introduction&lt;/h4&gt;
&lt;p&gt;Here are common Ruby patterns I use all the time, mainly in Rails apps.
Working on already fetched data is far more efficient than doing multiple queries, especially if the number of entries is rather “small” (to be defined, depends on your application).&lt;/p&gt;

&lt;p&gt;I avoid using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.group_by&lt;/code&gt; as much as I can as it can be very slow, depending on what Ruby can eager load. Doing something like &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;User.last(1000).group_by(&amp;amp;:team_id)&lt;/code&gt; is different from &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;User.last(1000).group_by(&amp;amp;:team)&lt;/code&gt;, the former grouping wrt an integer, the latter with an object! The latter will be very slow as it doesn’t eager load it and you will end up with an &lt;a href=&quot;https://guides.rubyonrails.org/active_record_querying.html#eager-loading-associations&quot;&gt;N+1 problem&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I have written the Javascript equivalent &lt;a href=&quot;/javascript-code-snippets&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;code-snippets&quot;&gt;Code Snippets&lt;/h3&gt;

&lt;h5 id=&quot;filter&quot;&gt;Filter&lt;/h5&gt;
&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;ar&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;ar&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;select&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;%&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# ↳ [2, 4, 6]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;map&quot;&gt;Map&lt;/h5&gt;
&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;ar&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;ar&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;collect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# ↳ [2, 4, 6, 8, 10, 12]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;reduce&quot;&gt;Reduce&lt;/h5&gt;
&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# Reduce starts with an initial accumulator value (here 0).&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# The block function is evaluated for each element of the iterator it&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# is called on (in order) and must return a new accumulator value.&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# The accumulator is an intermediate state shared among every block call.&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# Accumulator is returned after after last block call.&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;ar&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;ar&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;reduce&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;){&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;acc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;acc&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# ↳ 21&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# Reduce is also useful with hashes...&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;hash&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;a: &lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'b'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;c: &lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'d'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;e: &lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'f'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;hash&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;reduce&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;({}){&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;acc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;acc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;merge&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;({&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# ↳ {:a=&amp;gt;&quot;b&quot;, :c=&amp;gt;&quot;d&quot;, :e=&amp;gt;&quot;f&quot;}&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# ... or grouping by (unknown) keys&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;ar_h&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;key1: &lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'b'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;key2: &lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'a'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;key1: &lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'d'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;key2: &lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'c'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}]&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;ar_h&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;reduce&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;({}){&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;acc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elem&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;acc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;merge&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;collect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;acc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;nil?&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;acc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;to_h&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# ↳ {:key1=&amp;gt;&quot;bd&quot;, :key2=&amp;gt;&quot;ac&quot;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;sort&quot;&gt;Sort&lt;/h5&gt;
&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# Sort takes 2 args&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;ar&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;ar&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;sort&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# ↳ [6, 5, 4, 3, 2, 1]&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# Sort by (only takes 1 arg)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;ar_h&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;mykey: &lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'b'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;mykey: &lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'a'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;mykey: &lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'d'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;mykey: &lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'c'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}]&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;ar_h&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;sort_by&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elem&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:mykey&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]}&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# ↳ [{:mykey=&amp;gt;&quot;a&quot;}, {:mykey=&amp;gt;&quot;b&quot;}, {:mykey=&amp;gt;&quot;c&quot;}, {:mykey=&amp;gt;&quot;d&quot;}]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;find&quot;&gt;Find&lt;/h5&gt;
&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;ar_h&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;key1: &lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'b'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;key2: &lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'a'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;key1: &lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'d'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;key2: &lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'c'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}]&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;ar_h&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;find&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elem&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:mykey&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'d'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# ↳ {mykey: 'd'}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;optional-chaining&quot;&gt;Optional chaining&lt;/h5&gt;
&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# Ruby Safe navigation operator (optional chaining):&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# use '&amp;amp;.' to navigate safely accross objects e.g:&lt;/span&gt;
&lt;span class=&quot;vi&quot;&gt;@contract&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;name&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name></name></author><category term="snippets" /><summary type="html">Introduction Here are common Ruby patterns I use all the time, mainly in Rails apps. Working on already fetched data is far more efficient than doing multiple queries, especially if the number of entries is rather “small” (to be defined, depends on your application).</summary></entry><entry><title type="html">Gcc most common used flags</title><link href="/gcc-most-common-used-flags" rel="alternate" type="text/html" title="Gcc most common used flags" /><published>2020-11-19T10:30:00+00:00</published><updated>2020-11-19T10:30:00+00:00</updated><id>/gcc-most-common-used-flags</id><content type="html" xml:base="/gcc-most-common-used-flags">&lt;h4 id=&quot;introduction&quot;&gt;Introduction&lt;/h4&gt;
&lt;p&gt;Compiling with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;gcc&lt;/code&gt; or &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;clang&lt;/code&gt; from the command line can be scary at first but with a few tricks it can prove to be very useful and thrilling to use.&lt;/p&gt;

&lt;p&gt;In this blog post / reference page I’ll describe what I consider best practices, at least some tricks I use in my C/C++ projects and that saved me hours of headache.&lt;/p&gt;

&lt;p&gt;I’ll regularly update this post as far as I find time to cover the needed material to become confident when compiling with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;gcc&lt;/code&gt; / &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;clang&lt;/code&gt;.&lt;/p&gt;

&lt;h4 id=&quot;gcc-vs-clang-vs-&quot;&gt;Gcc vs clang vs …?&lt;/h4&gt;
&lt;p&gt;I’ve heard this many times. Which one is better / faster / stronger? Ill-posed problem! If you are trying to oppose them against each other you are doing it wrong! 🙅&lt;/p&gt;

&lt;p&gt;They can both reveal sometimes better, sometimes worse. Same applies to other compilers. I’m not talking about the binaries they produce (although observing significant performance or size differences between binaries from multiple compilers can put under the spotlight some code weaknesses or at least some weirdness because that mean they all not interpret your code the same way → most probably code smell 🧦) but about the (debug) information they can provide.&lt;/p&gt;

&lt;p&gt;The best practice I use is that I compile my code with them &lt;strong&gt;both&lt;/strong&gt; (well, not at the same time obviously). It’s particularly useful when facing compiling errors you don’t fully understand, because one can sometimes output a clearer error than the other and vice-versa. Their respective static analyzers (starting at GCC 10+) will help you find these bugs and give you why this is illegal code. That obviously doesn’t mean your code will work once compiling without warnings / errors but it’s at least a good start!&lt;/p&gt;

&lt;p&gt;Don’t oppose compilers between each other, embrace their differences. Having your code compiling on many of them is a very good sign your code is portable and respects standards.&lt;/p&gt;

&lt;h3 id=&quot;most-common-gcc-flags&quot;&gt;Most common gcc flags&lt;/h3&gt;
&lt;p&gt;You can install &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;gcc&lt;/code&gt; man-pages via &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sudo apt install gcc-doc&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;GCC compilation flags are grouped by usage in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;man gcc&lt;/code&gt;. Among all the categories, the first one to consider is: &lt;strong&gt;Warning Options&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;It lists the flags controlling compilation warnings. There is A LOT of flags, you don’t need to know them all. Some are very specific and are only useful if you (cross-)compile to some unusual architecture or deal with some hardware which behavior can confuse the compiler if not configured properly.&lt;/p&gt;

&lt;p&gt;Here is a list of very useful warnings, covering most use-cases when used together:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-Wall&lt;/code&gt; show all warnings. It won’t activate ALL warnings as the name suggest but already a lot of them;&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-Wextra&lt;/code&gt; activate some extra warnings;&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-Werror&lt;/code&gt; treat warnings as errors. YOU WANT THIS. I always consider &lt;em&gt;“A warning at compile time is an error an runtime”&lt;/em&gt;. Trust me, it will save you some time!&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-Wfatal-errors&lt;/code&gt; stop at first encountered error. Don’t let &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;g++&lt;/code&gt; be &lt;em&gt;that&lt;/em&gt; verbose 🙉;&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-Wpedantic&lt;/code&gt; Issue all the warnings demanded by strict ISO C and ISO C++; reject all programs that use forbidden extensions, and some other programs that do not follow ISO C and ISO C++.&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-pedantic-errors&lt;/code&gt; Give an error whenever the base standard requires a diagnostic.&lt;/li&gt;
&lt;/ul&gt;

&lt;p class=&quot;warning&quot;&gt;
  🧐 Always consider &lt;code&gt;-Wpedantic&lt;/code&gt; and &lt;code&gt;-pedantic-errors&lt;/code&gt; as DEBUG flags.&lt;br /&gt;Never put &lt;code&gt;-Wpedantic&lt;/code&gt; in production code, as the outputted warnings can vary from standard to standard. Simply upgrading your compiler version can make it consider a more recent standard as the new default and some new pedantic warnings / errors might appear, preventing your code to compile. Suddenly your customer starts yelling at you as she can't compile your code anymore while nothing has changed on your side! Beware 🛡️ !
&lt;/p&gt;

&lt;p&gt;Aside from the &lt;strong&gt;Warning Options&lt;/strong&gt; category flags, you’ll most probably need three other ones to make your code compile in the real world: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-I&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-L&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-l&lt;/code&gt;. These three flags tell the compiler where to look for header files (describing libraries’ APIs), libraries locations and which libraries to link against, respectively.&lt;/p&gt;

&lt;p&gt;As stated in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;man gcc&lt;/code&gt;, it makes a difference where in the command you write &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-l&lt;/code&gt;:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;the linker searches and processes libraries and object files in
the order they are specified.  Thus, foo.o -lz bar.o searches
library z after file foo.o but before bar.o.  If bar.o refers to
functions in z, those functions may not be loaded.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;A typical &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;gcc&lt;/code&gt; line will be:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;gcc &lt;span class=&quot;nt&quot;&gt;-Wall&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Werror&lt;/span&gt; ... &lt;span class=&quot;nt&quot;&gt;-Ipath&lt;/span&gt;/to/header/files &lt;span class=&quot;nt&quot;&gt;-Lpath&lt;/span&gt;/to/library/locations &lt;span class=&quot;nt&quot;&gt;-lmylib&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You can use &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-I&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-L&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-l&lt;/code&gt; flags multiple times.&lt;/p&gt;

&lt;p class=&quot;warning&quot;&gt;
  &lt;strong&gt;🧐 Should I fix warnings from third-party libraries?&lt;/strong&gt;&lt;br /&gt;
  Compiling with &lt;code&gt;-Werror&lt;/code&gt; can be cumbersome when using third party libraries. These libraries can generate some warnings and your code won't compile. Although you can post Pull Requests to fix them (if this is relevant) you might also consider life is what it is and you can't do anything about these warnings. The easiest solution is to include them as system libraries with &lt;code&gt;-isystem&lt;/code&gt; instead of &lt;code&gt;-I&lt;/code&gt;. GCC will know you can't do anything about the source code from these and won't bother you anymore. Neat!
&lt;/p&gt;

&lt;h4 id=&quot;pkg-config-to-the-rescue&quot;&gt;pkg-config to the rescue&lt;/h4&gt;
&lt;p&gt;Knowing headers / lib files locations can be difficult when compiling on multiple platforms / OSes. &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;pkg-config&lt;/code&gt; can help you by outputting compiler flags configured with their correct location on the local system. For instance:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# Library cURL, named libcurl&lt;/span&gt;
pkg-config &lt;span class=&quot;nt&quot;&gt;--libs&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--cflags&lt;/span&gt; libcurl
&lt;span class=&quot;c&quot;&gt;# Will output:&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;-I&lt;/span&gt;/usr/include/x86_64-linux-gnu &lt;span class=&quot;nt&quot;&gt;-lcurl&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Very handy when writing a Makefile (see below)!&lt;/p&gt;

&lt;h3 id=&quot;reference-makefile&quot;&gt;Reference Makefile&lt;/h3&gt;
&lt;p&gt;Here is a minimal Makefile as reference. Say &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;libcurl&lt;/code&gt; is a dependency we need to link against.&lt;/p&gt;

&lt;p&gt;Build your program by typing &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;make&lt;/code&gt; in the same directory.&lt;/p&gt;

&lt;div class=&quot;language-makefile highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;EXEC&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;my_output
&lt;span class=&quot;nv&quot;&gt;CC&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;g++
&lt;span class=&quot;nv&quot;&gt;DEBUGFLAGS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-g&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Wpedantic&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-pedantic-errors&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;CPPFLAGS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-Wall&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Werror&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Wextra&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Wfatal-errors&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;IFLAGS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;shell&lt;/span&gt; pkg-config &lt;span class=&quot;nt&quot;&gt;--cflags&lt;/span&gt; libcurl&lt;span class=&quot;nf&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;LFLAGS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;shell&lt;/span&gt; pkg-config &lt;span class=&quot;nt&quot;&gt;--libs&lt;/span&gt; libcurl&lt;span class=&quot;nf&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;nl&quot;&gt;all&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;$(EXEC)&lt;/span&gt;

&lt;span class=&quot;nl&quot;&gt;$(EXEC)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
	&lt;span class=&quot;nv&quot;&gt;$(CC)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$(DEBUGFLAGS)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$(CPPFLAGS)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$(IFLAGS)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$(LFLAGS)&lt;/span&gt; main.cpp &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$(EXEC)&lt;/span&gt;

&lt;span class=&quot;nl&quot;&gt;clean&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
	&lt;span class=&quot;nb&quot;&gt;rm&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;.o &lt;span class=&quot;nv&quot;&gt;$(EXEC)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;EXEC&lt;/code&gt; is the executable name (the final output);&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;CC&lt;/code&gt; is the C(++) compiler you use. &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;g++&lt;/code&gt; is part of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;gcc&lt;/code&gt;;&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;DEBUGFLAGS&lt;/code&gt; are the … debug flags. &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-g&lt;/code&gt; makes the compiler to output symbols in the binary, allowing a debugger to run it and set breakpoints. Pedantic flags are here listed as debug flags as said above;&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;CPPFLAGS&lt;/code&gt; are the compilation flags;
    &lt;ul&gt;
      &lt;li&gt;You might want to add the standard your code is written in via &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-std=c2x&lt;/code&gt;.&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;IFLAGS&lt;/code&gt;: list of directories to be searched for header files during preprocessing. Contains one or multiple &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-I&lt;/code&gt; flags followed by relative or absolute paths.&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;LFLAGS&lt;/code&gt;: list of libraries to link against.&lt;/li&gt;
&lt;/ul&gt;</content><author><name></name></author><category term="gcc" /><summary type="html">Introduction Compiling with gcc or clang from the command line can be scary at first but with a few tricks it can prove to be very useful and thrilling to use.</summary></entry><entry><title type="html">[1/5] Self hosted Nextcloud 20+</title><link href="/self-hosted-nextcloud-on-sbc-complete-guide-part1" rel="alternate" type="text/html" title="[1/5] Self hosted Nextcloud 20+" /><published>2020-10-12T10:30:00+00:00</published><updated>2020-10-12T10:30:00+00:00</updated><id>/complete-guide-to-self-hosted-nextcloud</id><content type="html" xml:base="/self-hosted-nextcloud-on-sbc-complete-guide-part1">&lt;p class=&quot;info&quot;&gt;
  📚 Installation on a single board computer: a complete guide
&lt;/p&gt;

&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;In this long post, I’ll describe how to configure a single board computer such as the &lt;strong&gt;Raspberry Pi&lt;/strong&gt; or the &lt;strong&gt;Asus Tinker Board&lt;/strong&gt; from A to Z to support a self-hosted Nextcloud 20+ instance. We’ll go through the following steps:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;#installing-a-recent-image&quot;&gt;PART 1 - Installing a recent Operating System (Debian 11 - bullseye)&lt;/a&gt;:
    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#installing-a-recent-image&quot;&gt;Preliminaries&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#copying-the-bootloader&quot;&gt;Copying the Bootloader&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#installing-a-recent-kernel-from-kernelorg&quot;&gt;Installing a recent Kernel from kernel.org (5.4 LTS supported until December 2025)&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#installing-debian-11-bullseye&quot;&gt;Installing Debian 11 Bullseye&lt;/a&gt; (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;debootstrap&lt;/code&gt;)&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part2&quot;&gt;PART 2 - Readonly root&lt;/a&gt;:
    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part2#read-only-root&quot;&gt;Partitioning a read-only root&lt;/a&gt; (via &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;overlayroot&lt;/code&gt;)&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part2#strengthening-the-read-only&quot;&gt;Strengthening the read-only&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part3&quot;&gt;PART 3&lt;/a&gt;:
    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part3#installing-mariadb&quot;&gt;Installing + configuring MariaDB&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part3#installing-nextcloud&quot;&gt;&lt;strong&gt;Installing Nextcloud 20+&lt;/strong&gt;&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;Installing and configuring &lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part3#installing-and-configuring-nginx&quot;&gt;Nginx&lt;/a&gt; or &lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part3#installing-and-configuring-apache&quot;&gt;Apache&lt;/a&gt; in front of it&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part3#configuring-nextcloud&quot;&gt;Tuning and tweaking Nextcloud 20+ freshly installed&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part4&quot;&gt;PART 4&lt;/a&gt;:
    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part4#lets-encrypt-tls-certificate&quot;&gt;Installing Let’s Encrypt SSL wildcard certificates&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part4#dynamic-host-via-ddclient&quot;&gt;Dynamic host via &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ddclient&lt;/code&gt;&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part5&quot;&gt;PART 5&lt;/a&gt;:
    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part5#deactivate-read-only-root&quot;&gt;Remounting as a read/write FS&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part5&quot;&gt;Updating Nextcloud&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;&quot;&gt;&lt;strong&gt;Backuping your SD Card&lt;/strong&gt;&lt;/a&gt; (do that regularly while going through this guide)&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;My personal board is an Asus Tinker Board, but I’ve played with Raspberry Pi 4s as well before, and the procedure is roughly the same (&amp;gt;90%). I’ll describe the differences when they arise (mainly at the image installation and cleanup steps).&lt;/p&gt;

&lt;h2 id=&quot;installing-a-recent-image&quot;&gt;Installing a recent image&lt;/h2&gt;

&lt;h4 id=&quot;raspberry-pi&quot;&gt;Raspberry pi&lt;/h4&gt;
&lt;p&gt;Download &lt;a href=&quot;https://www.raspberrypi.org/downloads/raspberry-pi-os/&quot;&gt;Raspberry Pi OS (32-bit) Lite&lt;/a&gt; image.&lt;/p&gt;

&lt;p&gt;Unzip the file; you’ll end up with an .img file like &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;YYY-MM-DD-raspios-buster-armhf-lite.img&lt;/code&gt;. The image is a dump of a 2Gb partition with ≃ 435Mb of content.&lt;/p&gt;

&lt;h4 id=&quot;tinker-board&quot;&gt;Tinker board&lt;/h4&gt;
&lt;p&gt;Download the latest image from &lt;a href=&quot;https://www.asus.com/uk/Single-Board-Computer/Tinker-Board/HelpDesk_Download/&quot;&gt;here&lt;/a&gt;. The latest one for TinkerBoard 1 is the &lt;strong&gt;2.1.16&lt;/strong&gt;. Starting at &lt;strong&gt;2.2.x&lt;/strong&gt; you must at least have a Tinker Board S (with UMS support).&lt;/p&gt;

&lt;p&gt;Unzip the file; you’ll end up with an .img file like &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Tinker_Board-Debian-Stretch-V2.1.16-20200813.img&lt;/code&gt;. The image is a dump of a 2Gb partition with an old Kernel (4.04) and an old Debian stretch 9. We’ll update that shortly, and only keep the bootloader.&lt;/p&gt;

&lt;h4 id=&quot;putting-the-image-on-the-sd-card&quot;&gt;Putting the image on the SD Card&lt;/h4&gt;

&lt;p&gt;To transfer the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.img&lt;/code&gt; content from your hard drive to the SDCard, copy its content via the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;dd&lt;/code&gt; command (Linux). Be aware you have to know which device name your SD card receives from the OS, &lt;strong&gt;your mileage may (will) vary&lt;/strong&gt;. The best way to know is probably to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ls /dev&lt;/code&gt; folder, then insert the SD Card, and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ls&lt;/code&gt; it again. The newly added device is your SD Card (e.g. &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/dev/sdb&lt;/code&gt;). If your SD Card has multiple partitions, they will appear with a number as suffix like &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/dev/sdb1&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/dev/sdb2&lt;/code&gt;, etc. We are only interested in the device name (e.g. &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/dev/sdb&lt;/code&gt;), &lt;strong&gt;not&lt;/strong&gt; the partition name(s).&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# Transfer the .img content to SD Card&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo dd &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;bs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;4M &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;Tinker_Board-Debian-Stretch-V2.1.16-20200813.img &lt;span class=&quot;nv&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/dev/sdb &lt;span class=&quot;nv&quot;&gt;status&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;progress &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;sync&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;⌛ This will take some time, be patient.&lt;/p&gt;

&lt;p&gt;Once done, starting &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;gparted&lt;/code&gt; can be handy to extend the copied partition. SD Cards have &amp;gt; than 16Gb by now, and the copied image is a 2Gb partition.&lt;/p&gt;

&lt;p&gt;If you have a raspberry pi, you are good to go and can directly jump to &lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part2&quot;&gt;Part 2&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&quot;copying-the-bootloader&quot;&gt;Copying the Bootloader&lt;/h2&gt;

&lt;h4 id=&quot;u-boot-vanilla&quot;&gt;U-boot vanilla?&lt;/h4&gt;
&lt;p&gt;Theoretically, the TinkerBoard is officially supported by u-boot and we should compile it like this:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; /tmp
git clone https://source.denx.de/u-boot/u-boot.git
&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;u-boot

make &lt;span class=&quot;nv&quot;&gt;CROSS_COMPILE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;arm-linux-gnueabihf- tinker-rk3288_defconfig
&lt;span class=&quot;c&quot;&gt;# If you want to see U-boot outputs, set SILENT_CONSOLE option to Yes via menuconfig&lt;/span&gt;

make &lt;span class=&quot;nv&quot;&gt;CROSS_COMPILE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;arm-linux-gnueabihf- &lt;span class=&quot;nt&quot;&gt;-j15&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;By convention, UART2 is used by Rockchip for serial output: pin 32 for TX, 33 for RX and 30 as GND. Do not connect Vcc, prefer an external power supply.&lt;/p&gt;

&lt;p&gt;Transfer it on the SD card via the following command:&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo dd &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;u-boot-rockchip.bin &lt;span class=&quot;nv&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/dev/mmcblk0 &lt;span class=&quot;nv&quot;&gt;seek&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;64
&lt;span class=&quot;nb&quot;&gt;sync&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The problem is: via this technique, U-boot has never been able to find the kernel on the first partition. I can see U-boot’s output but I get a weird error. Please contact me (via the comments below) if you were able to configure the sources to make it boot nicely, I would be more than happy to have a recent u-boot on my board!&lt;/p&gt;

&lt;h4 id=&quot;u-boot-from-asus-fork&quot;&gt;U-boot from Asus fork?&lt;/h4&gt;
&lt;p&gt;As we can’t compile a fresh u-boot, let’s compile the sources from Asus’s fork! Located &lt;a href=&quot;https://github.com/TinkerBoard/debian_u-boot&quot;&gt;here&lt;/a&gt;. I tried to compare the modifications done on the fork with the original repo but the two are too far away now and many options disappeared, changed their name, or have been added. I could find a reliable way to compare and set the same fork’s configuration on u-boot sources.&lt;/p&gt;

&lt;p&gt;In addition to that, &lt;a href=&quot;https://github.com/TinkerBoard/debian_u-boot/issues/8#issuecomment-812232236&quot;&gt;you need an old Ubuntu distribution&lt;/a&gt; to make it compile, otherwise your build will fail.&lt;/p&gt;

&lt;h4 id=&quot;u-boot-from-the-given-image&quot;&gt;U-boot from the given image&lt;/h4&gt;
&lt;p&gt;Our last chance is to use the already compiled u-boot binary from the given image. We can’t recreate it but we can use it! If you copied the given image on an SD card, you have nothing to do. U-boot binary is already at sector 64.&lt;/p&gt;

&lt;h2 id=&quot;installing-a-recent-kernel-from-kernelorg&quot;&gt;Installing a recent Kernel from kernel.org&lt;/h2&gt;
&lt;p&gt;Let the fun begin!&lt;/p&gt;

&lt;p&gt;Download the kernel sources and compile them on the host machine, don’t do this on the target.&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# ON THE HOST MACHINE&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# Installing required compilers&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;apt &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;gcc-arm-linux-gnueabihf device-tree-compiler gcc-aarch64-linux-gnu bc

&lt;span class=&quot;c&quot;&gt;# Downloading the vanilla kernel:&lt;/span&gt;
git clone https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git
&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;linux
git branch &lt;span class=&quot;nt&quot;&gt;--list&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--remotes&lt;/span&gt;
git branch &lt;span class=&quot;nt&quot;&gt;--show-current&lt;/span&gt;
git checkout linux-5.4.y &lt;span class=&quot;c&quot;&gt;# 5.4 is LTS until Dec, 2025&lt;/span&gt;
                         &lt;span class=&quot;c&quot;&gt;# 5.10   LTS doesn't boot with Asus defconfig&lt;/span&gt;
                         &lt;span class=&quot;c&quot;&gt;# See: https://www.kernel.org/category/releases.html&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# Download kernel configuration for the target board&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# Asus gives a file for Tinkerboard / TinkerBoard S / TinkerBoard 2&lt;/span&gt;
curl &lt;span class=&quot;nt&quot;&gt;-L&lt;/span&gt; https://raw.githubusercontent.com/TinkerBoard/debian_kernel/develop/arch/arm/configs/miniarm-rk3288_defconfig &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;arch&lt;/span&gt;/arm/configs/miniarm-rk3288_defconfig

&lt;span class=&quot;c&quot;&gt;# Configure the kernel sources with the downloaded configuration file&lt;/span&gt;
make &lt;span class=&quot;nv&quot;&gt;ARCH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;arm miniarm-rk3288_defconfig &lt;span class=&quot;nt&quot;&gt;-j16&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# (a couple of warnings might appear but they should be harmless)&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# We now need to add 'overlayfs' support as a module.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# The below command will start a terminal GUI, where you can browse the kernel config options&lt;/span&gt;
make &lt;span class=&quot;nv&quot;&gt;ARCH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;arm menuconfig
&lt;span class=&quot;c&quot;&gt;# overlayfs is at 'File systems' → 'Overlay Filesystem Support' and must be set to 'M'&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# hardware crypto module support is at ' Cryptographic API' → 'Hardware crypto devices' → 'Rockchip's Cryptographic Engine driver' and must be set to 'M'&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# Compile kernel and its modules&lt;/span&gt;
make zImage &lt;span class=&quot;nv&quot;&gt;ARCH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;arm &lt;span class=&quot;nv&quot;&gt;CROSS_COMPILE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;arm-linux-gnueabihf- &lt;span class=&quot;nt&quot;&gt;-j16&lt;/span&gt;
make modules &lt;span class=&quot;nv&quot;&gt;ARCH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;arm &lt;span class=&quot;nv&quot;&gt;CROSS_COMPILE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;arm-linux-gnueabihf- &lt;span class=&quot;nt&quot;&gt;-j16&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# Tinker's dts is in mainline kernel, under the name rk3288-tinker.dts&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# (see: arm/boot/dts/rk3288-tinker.dts)&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# so compile it as well to a dtb file (binary)&lt;/span&gt;
make &lt;span class=&quot;nv&quot;&gt;ARCH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;arm rk3288-tinker.dtb &lt;span class=&quot;nv&quot;&gt;CROSS_COMPILE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;arm-linux-gnueabihf- &lt;span class=&quot;nt&quot;&gt;-j16&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# Install modules to the SDCard's '/' partition (adapt 'sdX' below)&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;make &lt;span class=&quot;nv&quot;&gt;ARCH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;arm &lt;span class=&quot;nv&quot;&gt;INSTALL_MOD_PATH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/media/sdX/ modules_install

&lt;span class=&quot;c&quot;&gt;# Copy freshly compiled kernel to the SDcard's '/boot' partition (adapt 'sdY' below)&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;cp arch&lt;/span&gt;/arm/boot/zImage /media/sdY/zImage
&lt;span class=&quot;nb&quot;&gt;cp arch&lt;/span&gt;/arm/boot/dts/rk3288-tinker.dtb /media/sdY/rk3288-miniarm.dtb
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;🥳 Congratulations, your now have a freshly compiled kernel on your SD Card with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;overlayfs&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;rk_crypto&lt;/code&gt; support! 🎉&lt;/p&gt;

&lt;h2 id=&quot;installing-debian-11-bullseye&quot;&gt;Installing Debian 11 Bullseye&lt;/h2&gt;
&lt;p&gt;For this part, you’ll need to format (yes, format) the second partition made by copying the .img file. Prefer EXT4 filesystem.&lt;/p&gt;

&lt;p&gt;Once done, mount the partition in a temporary folder:&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;mkdir&lt;/span&gt; /tmp/os
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;mount /dev/sdb2 /tmp/os
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And use &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;deboostrap&lt;/code&gt; to install a fresh Debian stable. (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;apt install debootstrap&lt;/code&gt; might be necessary).&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# First Stage (downloading packages)&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo&lt;/span&gt; /usr/sbin/debootstrap &lt;span class=&quot;nt&quot;&gt;--arch&lt;/span&gt; armhf &lt;span class=&quot;nt&quot;&gt;--foreign&lt;/span&gt; stable /tmp/os https://deb.debian.org/debian/

&lt;span class=&quot;c&quot;&gt;# Second stage (unpacking packages in a chrooted env):&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# as the target arch is different, needed to use qemu to chroot&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;apt &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;qemu-user-static
&lt;span class=&quot;nb&quot;&gt;sudo cp&lt;/span&gt; /usr/bin/qemu-arm-static /tmp/os/usr/bin/
&lt;span class=&quot;nb&quot;&gt;sudo chroot&lt;/span&gt; /tmp/os /usr/bin/qemu-arm-static /bin/bash &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# When chrooted, run the second stage&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#  /debootstrap/debootstrap --second-stage&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;minimal-configuration&quot;&gt;Minimal configuration&lt;/h4&gt;
&lt;p&gt;Still in the chrooted environment,&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# Update root password&lt;/span&gt;
passwd

&lt;span class=&quot;c&quot;&gt;# Specify hostname&lt;/span&gt;
nano /etc/hostname

&lt;span class=&quot;c&quot;&gt;# Modify FSTAB&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# Add the following lines (mind the tabs):&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# /dev/mmcblk0p2	/	ext4	defaults	0	1&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# /dev/mmcblk0p1	/boot	vfat	defaults	0	2&lt;/span&gt;
nano /etc/fstab 

&lt;span class=&quot;c&quot;&gt;# Enable serial console&lt;/span&gt;
systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;serial-getty@ttyS0.service

&lt;span class=&quot;c&quot;&gt;# Configure locales&lt;/span&gt;
apt &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;locales

apt update
apt &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;git openssh-server vim firmware-linux firmware-linux-nonfree firmware-linux-free firmware-realtek firmware-iwlwifi cron acl build-essential debian-keyring initramfs-tools autoconf automake libtool &lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;ufw curl lsb-release cryptsetup cryptsetup-bin unzip curl

useradd &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; sheeva
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;sheeva:monpassword&quot;&lt;/span&gt; | chpasswd
adduser sheeva &lt;span class=&quot;nb&quot;&gt;sudo
&lt;/span&gt;dpkg-reconfigure locales
vim /etc/ssh/sshd_config
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;upgrading-source-list&quot;&gt;Upgrading Source list:&lt;/h5&gt;
&lt;p&gt;update &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/apt/sources.list&lt;/code&gt; with the following content:&lt;/p&gt;

&lt;div class=&quot;language-conf highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;deb&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;http&lt;/span&gt;://&lt;span class=&quot;n&quot;&gt;deb&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;debian&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;org&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;debian&lt;/span&gt;/ &lt;span class=&quot;n&quot;&gt;stable&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;contrib&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;non&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;free&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;deb&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;src&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;http&lt;/span&gt;://&lt;span class=&quot;n&quot;&gt;deb&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;debian&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;org&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;debian&lt;/span&gt;/ &lt;span class=&quot;n&quot;&gt;stable&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;contrib&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;non&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;free&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;deb&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;http&lt;/span&gt;://&lt;span class=&quot;n&quot;&gt;deb&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;debian&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;org&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;debian&lt;/span&gt;/ &lt;span class=&quot;n&quot;&gt;stable&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;updates&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;contrib&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;non&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;free&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;deb&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;src&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;http&lt;/span&gt;://&lt;span class=&quot;n&quot;&gt;deb&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;debian&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;org&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;debian&lt;/span&gt;/ &lt;span class=&quot;n&quot;&gt;stable&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;updates&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;contrib&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;non&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;free&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# Added from https://wiki.debian.org/Backports#Using_the_command_line
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;deb&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;http&lt;/span&gt;://&lt;span class=&quot;n&quot;&gt;deb&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;debian&lt;/span&gt;.&lt;span class=&quot;n&quot;&gt;org&lt;/span&gt;/&lt;span class=&quot;n&quot;&gt;debian&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bullseye&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;backports&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;contrib&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;non&lt;/span&gt;-&lt;span class=&quot;n&quot;&gt;free&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;setting-up-a-static-ip-address&quot;&gt;Setting up a static IP address&lt;/h5&gt;
&lt;p&gt;As this SBC will become a Nextcloud server, it’s better to assign it a fixed IP. Add the following in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/network/interfaces.d/eth0&lt;/code&gt; (file won’t exist):&lt;/p&gt;
&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;auto eth0
iface eth0 inet static
address 192.168.1.XXX
netmask 255.255.255.0
network 192.168.1.0
broadcast 192.168.1.255
gateway 192.168.1.1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/network/interfaces&lt;/code&gt; imports &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/network/interfaces.d/*&lt;/code&gt;, names doesn’t matter.
Replace &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;XXX&lt;/code&gt; with the actual IP address you want to assign your board.&lt;/p&gt;

&lt;h5 id=&quot;securing-ssh&quot;&gt;Securing SSH&lt;/h5&gt;
&lt;p&gt;Only allow connection via &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$MYUSER&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;sudo &lt;/span&gt;vim /etc/ssh/sshd_config

&lt;span class=&quot;c&quot;&gt;# Add/Modify the following directives:&lt;/span&gt;
AllowUsers MYUSER
PermitRootLogin no
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Other ssh tweaks can be found &lt;a href=&quot;https://www.digitalocean.com/community/tutorials/ssh-essentials-working-with-ssh-servers-clients-and-keys&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;🥳 Congratulations, your now have a freshly installed Debian stable on your SD Card! 🎉&lt;/p&gt;

&lt;h2 id=&quot;next&quot;&gt;Next&lt;/h2&gt;

&lt;p&gt;See &lt;a href=&quot;/self-hosted-nextcloud-on-sbc-complete-guide-part2&quot;&gt;PART 2&lt;/a&gt;&lt;/p&gt;</content><author><name></name></author><category term="nextcloud" /><summary type="html">📚 Installation on a single board computer: a complete guide</summary></entry></feed>